{% extends "base.html" %}

{% block title %}Alan Y√∂netimi - OBA Robot{% endblock %}

{% block extra_css %}
<style>
    .area-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: #f9f9f9;
    }

    .area-map {
        width: 100%;
        height: 300px;
        border: 1px solid #ccc;
        background: #f0f0f0;
        position: relative;
        cursor: crosshair;
    }

    .area-point {
        position: absolute;
        width: 8px;
        height: 8px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
        transform: translate(-50%, -50%);
    }

    .area-polygon {
        position: absolute;
        border: 2px solid #007bff;
        background: rgba(0, 123, 255, 0.1);
        pointer-events: none;
    }

    .btn-group {
        margin-bottom: 10px;
    }

    .area-stats {
        background: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
        }
    }

    .area-highlight {
        pointer-events: none;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <h2>üèûÔ∏è √áalƒ±≈üma Alanlarƒ±</h2>

            <!-- Alan Listesi -->
            <div id="area-list">
                <!-- Dinamik alan kartlarƒ± buraya JavaScript ile y√ºklenecek -->
            </div>

            <!-- Yeni Alan Ekleme -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5>‚ûï Yeni Alan Ekle</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary" onclick="startAreaCreation()">
                        üó∫Ô∏è Harita √úzerinde √áiz
                    </button>
                    <button class="btn btn-secondary ml-2" onclick="importFromGPS()">
                        üìç GPS Koordinatlarƒ±ndan ƒ∞√ße Aktar
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Harita/Planlama Paneli -->
            <div class="card">
                <div class="card-header">
                    <h5>üó∫Ô∏è Alan Haritasƒ±</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" onclick="setMapMode('view')">
                            üëÅÔ∏è G√∂r√ºnt√ºle
                        </button>
                        <button class="btn btn-outline-primary" onclick="setMapMode('edit')">
                            ‚úèÔ∏è D√ºzenle
                        </button>
                        <button class="btn btn-outline-primary" onclick="setMapMode('create')">
                            ‚ûï Olu≈ütur
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="area-map" id="area-map">
                        <!-- Dinamik alan g√∂rselle≈ütirmeleri buraya JavaScript ile eklenecek -->

                        <!-- Robot pozisyonu -->
                        <div class="area-point" style="left: 50%; top: 50%; background: #dc3545;"
                            title="Robot Pozisyonu"></div>

                        <!-- ≈ûarj istasyonu -->
                        <div class="area-point" style="left: 10%; top: 10%; background: #28a745;"
                            title="≈ûarj ƒ∞stasyonu"></div>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>A√ßƒ±klama:</strong><br>
                            üü¶ Mavi: Tanƒ±mlƒ± alanlar<br>
                            üî¥ Kƒ±rmƒ±zƒ±: Robot pozisyonu<br>
                            üü¢ Ye≈üil: ≈ûarj istasyonu<br>
                            Haritaya tƒ±klayarak yeni alan olu≈üturabilirsiniz.
                        </small>
                    </div>
                </div>
            </div>

            <!-- Alan ƒ∞statistikleri -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5>üìä Alan ƒ∞statistikleri</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">2</h4>
                            <small>Tanƒ±mlƒ± Alan</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">975 m¬≤</h4>
                            <small>Toplam Alan</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-info">75 dk</h4>
                            <small>Toplam S√ºre</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning">20</h4>
                            <small>Toplam Bi√ßim</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alan D√ºzenleme Modal -->
<div class="modal fade" id="editAreaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Alan D√ºzenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body">
                <form id="editAreaForm">
                    <div class="form-group">
                        <label>Alan Adƒ±:</label>
                        <input type="text" class="form-control" id="areaName" placeholder="√ñrn: Doƒüu Bah√ße">
                    </div>

                    <div class="form-group">
                        <label>Bi√ßme Ayarlarƒ±:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="small">Bi√ßme Y√ºksekliƒüi (cm):</label>
                                <select class="form-control" id="cuttingHeight">
                                    <option value="3">3 cm (En D√º≈ü√ºk)</option>
                                    <option value="5" selected>5 cm (Normal)</option>
                                    <option value="7">7 cm (Orta)</option>
                                    <option value="10">10 cm (Y√ºksek)</option>
                                    <option value="12">12 cm (En Y√ºksek)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="small">Hƒ±z:</label>
                                <select class="form-control" id="mowingSpeed">
                                    <option value="0.2">Yava≈ü (0.2 m/s)</option>
                                    <option value="0.4" selected>Normal (0.4 m/s)</option>
                                    <option value="0.6">Hƒ±zlƒ± (0.6 m/s)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Bi√ßme D√ºzeni:</label>
                        <select class="form-control" id="mowingPattern">
                            <option value="lawn_mower" selected>Bi√ßerd√∂ver (Paralel)</option>
                            <option value="spiral">Spiral</option>
                            <option value="random">Rastgele</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Koordinatlar:</label>
                        <textarea class="form-control" id="areaCoordinates" rows="4"
                            placeholder="(0,0), (30,0), (30,20), (0,20)"></textarea>
                        <small class="text-muted">Her satƒ±ra bir koordinat √ßifti (x,y) yazƒ±n</small>
                    </div>

                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="enableSchedule">
                            <label class="custom-control-label" for="enableSchedule">
                                Otomatik Zamanlama
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="scheduleOptions" style="display: none;">
                        <label>Zamanlama:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-control" id="scheduleFrequency">
                                    <option value="daily">G√ºnl√ºk</option>
                                    <option value="weekly" selected>Haftalƒ±k</option>
                                    <option value="monthly">Aylƒ±k</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <input type="time" class="form-control" id="scheduleTime" value="09:00">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    ‚ùå ƒ∞ptal
                </button>
                <button type="button" class="btn btn-primary" onclick="saveArea()">
                    ‚úÖ Kaydet
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentMapMode = 'view';
    let selectedArea = null;
    let newAreaPoints = [];

    // Harita modu deƒüi≈ütirme
    function setMapMode(mode) {
        currentMapMode = mode;
        $('.btn-group .btn').removeClass('active');
        $(`button[onclick="setMapMode('${mode}')"]`).addClass('active');

        const map = document.getElementById('area-map');

        switch (mode) {
            case 'view':
                map.style.cursor = 'default';
                break;
            case 'edit':
                map.style.cursor = 'grab';
                break;
            case 'create':
                map.style.cursor = 'crosshair';
                newAreaPoints = [];
                break;
        }
    }

    // Alan bi√ßme ba≈ülatma
    function startMowing(areaId) {
        if (confirm(`${areaId} alanƒ±nda bi√ßme i≈ülemini ba≈ülatmak istiyor musunuz?`)) {
            // Ger√ßek API √ßaƒürƒ±sƒ±
            fetch(`/api/areas/${areaId}/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('üöÄ Bi√ßme i≈ülemi ba≈ülatƒ±ldƒ±!', 'success');
                        // Alan kartƒ±ndaki durumu g√ºncelle
                        updateAreaStatus(areaId, 'Bi√ßiliyor');
                    } else {
                        showNotification(`‚ùå Bi√ßme ba≈ülatƒ±lamadƒ±: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Bi√ßme ba≈ülatma hatasƒ±:', error);
                    showNotification('‚ùå Baƒülantƒ± hatasƒ±', 'danger');
                });
        }
    }

    // Alan d√ºzenleme
    function editArea(areaId) {
        selectedArea = areaId;

        // Ger√ßek API'den alan bilgilerini y√ºkle
        fetch(`/api/areas/${areaId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(`‚ùå Alan bulunamadƒ±: ${data.error}`, 'danger');
                    return;
                }

                // Modal'daki form alanlarƒ±nƒ± doldur
                document.getElementById('areaName').value = data.name;
                document.getElementById('cuttingHeight').value = data.blade_height;
                document.getElementById('mowingSpeed').value = data.speed;
                document.getElementById('mowingPattern').value = data.pattern;

                // Koordinatlarƒ± string formatƒ±na √ßevir
                const coordString = data.boundary.map(p =>
                    `(${p.x.toFixed(1)},${p.y.toFixed(1)})`
                ).join(', ');
                document.getElementById('areaCoordinates').value = coordString;

                // Modal'ƒ± g√∂ster
                const modal = new bootstrap.Modal(document.getElementById('editAreaModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Alan y√ºkleme hatasƒ±:', error);
                showNotification('‚ùå Alan bilgileri y√ºklenemedi', 'danger');
            });
    }

    // Alan g√∂sterme/gizleme
    function showArea(areaId) {
        // Alan kartƒ±nƒ± vurgula
        $('.area-card').removeClass('border-primary');
        const areaCard = $(`.area-card[data-area-id="${areaId}"]`);
        areaCard.addClass('border-primary');

        // Alan bilgilerini API'den getir
        fetch(`/api/areas/${areaId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(`‚ùå Alan bulunamadƒ±: ${data.error}`, 'danger');
                    return;
                }

                // Haritada alanƒ± vurgula
                highlightAreaOnMap(data.boundary);

                // Alan detay bilgilerini g√∂ster
                showAreaDetails(data);
            })
            .catch(error => {
                console.error('Alan g√∂sterme hatasƒ±:', error);
                showNotification('‚ùå Alan bilgileri y√ºklenemedi', 'danger');
            });
    }

    // Haritada alanƒ± vurgula
    function highlightAreaOnMap(boundary) {
        // √ñnce eski vurgularƒ± temizle
        $('.area-highlight').remove();

        if (boundary.length < 3) return;

        // Alan sƒ±nƒ±rlarƒ±nƒ± hesapla
        const minX = Math.min(...boundary.map(p => p.x));
        const minY = Math.min(...boundary.map(p => p.y));
        const maxX = Math.max(...boundary.map(p => p.x));
        const maxY = Math.max(...boundary.map(p => p.y));

        // Harita boyutlarƒ±na g√∂re piksel koordinatlarƒ±na √ßevir
        const mapWidth = $('#area-map').width();
        const mapHeight = $('#area-map').height();

        const pixelMinX = (minX / 50) * mapWidth;
        const pixelMinY = (minY / 30) * mapHeight;
        const pixelMaxX = (maxX / 50) * mapWidth;
        const pixelMaxY = (maxY / 30) * mapHeight;

        // Vurgulama alanƒ± olu≈ütur
        const highlight = $('<div class="area-highlight"></div>');
        highlight.css({
            position: 'absolute',
            left: pixelMinX + 'px',
            top: pixelMinY + 'px',
            width: (pixelMaxX - pixelMinX) + 'px',
            height: (pixelMaxY - pixelMinY) + 'px',
            border: '3px solid #ffc107',
            background: 'rgba(255, 193, 7, 0.2)',
            borderRadius: '4px',
            animation: 'pulse 2s infinite'
        });

        $('#area-map').append(highlight);

        // 5 saniye sonra vurguyu kaldƒ±r
        setTimeout(() => {
            highlight.fadeOut(() => highlight.remove());
        }, 5000);
    }

    // Alan detaylarƒ±nƒ± g√∂ster
    function showAreaDetails(areaData) {
        const area_m2 = calculateAreaSize(areaData.boundary);
        const estimatedTime = Math.round(area_m2 / 100); // 100 m¬≤/dk varsayƒ±mƒ±

        // Eƒüer zaten varsa √∂nceki modal'ƒ± temizle
        const existingModal = document.getElementById('areaDetailModal');
        if (existingModal) {
            existingModal.remove();
        }

        const modalHTML = `
        <div class="modal fade" id="areaDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üìã ${areaData.name} - Alan Detaylarƒ±</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>üìè Alan Bilgileri</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Alan:</strong> ${area_m2.toFixed(1)} m¬≤</li>
                                    <li><strong>Nokta Sayƒ±sƒ±:</strong> ${areaData.boundary.length}</li>
                                    <li><strong>Desen:</strong> ${getPatternName(areaData.pattern)}</li>
                                    <li><strong>Tahmini S√ºre:</strong> ${estimatedTime} dakika</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>‚öôÔ∏è Bi√ßme Ayarlarƒ±</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Bƒ±√ßak Y√ºksekliƒüi:</strong> ${areaData.blade_height} cm</li>
                                    <li><strong>Hƒ±z:</strong> ${areaData.speed} m/s</li>
                                    <li><strong>Overlap:</strong> ${(areaData.overlap * 100).toFixed(0)}%</li>
                                </ul>
                            </div>
                        </div>

                        <hr>

                        <h6>üìç Koordinatlar</h6>
                        <div style="max-height: 150px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Nokta</th>
                                        <th>X (m)</th>
                                        <th>Y (m)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${areaData.boundary.map((point, index) => `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>${point.x.toFixed(2)}</td>
                                            <td>${point.y.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="startMowing('${areaData.id}'); closeAreaDetailModal();">
                            ‚úÇÔ∏è Bi√ßmeye Ba≈üla
                        </button>
                        <button type="button" class="btn btn-primary" onclick="editArea('${areaData.id}'); closeAreaDetailModal();">
                            ‚úèÔ∏è D√ºzenle
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå Kapat</button>
                    </div>
                </div>
            </div>
        </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('areaDetailModal'));
        modal.show();

        // Modal kapandƒ±ƒüƒ±nda temizle
        document.getElementById('areaDetailModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
            document.querySelectorAll('.area-card').forEach(card => {
                card.classList.remove('border-primary');
            });
        });
    }

    // Alan detay modalƒ±nƒ± kapat yardƒ±mcƒ± fonksiyonu
    function closeAreaDetailModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('areaDetailModal'));
        if (modal) {
            modal.hide();
        }
    }

    // Alan silme
    function deleteArea(areaId) {
        if (confirm('Bu alanƒ± silmek istediƒüinizden emin misiniz?')) {
            fetch(`/api/areas/${areaId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Alan kartƒ±nƒ± kaldƒ±r
                        $(`.area-card[data-area-id="${areaId}"]`).fadeOut(() => {
                            $(this).remove();
                        });
                        showNotification('üóëÔ∏è Alan silindi', 'warning');
                        // Sayfa istatistiklerini g√ºncelle
                        updateAreaStatistics();
                    } else {
                        showNotification(`‚ùå Alan silinemedi: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Alan silme hatasƒ±:', error);
                    showNotification('‚ùå Baƒülantƒ± hatasƒ±', 'danger');
                });
        }
    }

    // Alan kaydetme
    function saveArea() {
        const areaName = document.getElementById('areaName').value.trim();
        const coordinates = document.getElementById('areaCoordinates').value.trim();

        if (!areaName) {
            showNotification('‚ùå Alan adƒ± gerekli', 'warning');
            return;
        }

        if (!coordinates) {
            showNotification('‚ùå Koordinatlar gerekli', 'warning');
            return;
        }

        // Koordinatlarƒ± parse et
        let boundary;
        try {
            boundary = parseCoordinates(coordinates);
        } catch (error) {
            showNotification('‚ùå Ge√ßersiz koordinat formatƒ±', 'warning');
            return;
        }

        const areaData = {
            name: areaName,
            blade_height: parseInt(document.getElementById('cuttingHeight').value),
            speed: parseFloat(document.getElementById('mowingSpeed').value),
            pattern: document.getElementById('mowingPattern').value,
            boundary: boundary,
            overlap: 0.1
        };

        // API'ye g√∂nder
        fetch(`/api/areas/${selectedArea}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(areaData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editAreaModal'));
                    modal.hide();
                    showNotification('‚úÖ Alan ayarlarƒ± kaydedildi', 'success');
                    // Sayfa yenilenmeden alan kartƒ±nƒ± g√ºncelle
                    updateAreaCard(selectedArea, areaData);
                } else {
                    showNotification(`‚ùå Kaydetme hatasƒ±: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Alan kaydetme hatasƒ±:', error);
                showNotification('‚ùå Baƒülantƒ± hatasƒ±', 'danger');
            });
    }

    // Yeni alan olu≈üturma ba≈ülatma
    function startAreaCreation() {
        setMapMode('create');
        showNotification('üó∫Ô∏è Harita √ºzerinde alan sƒ±nƒ±rlarƒ±nƒ± √ßizin', 'info');
    }

    // GPS i√ße aktarma
    function importFromGPS() {
        // GPS koordinat i√ße aktarma modalƒ±nƒ± olu≈ütur ve g√∂ster
        const importModal = $(`
        <div class="modal fade" id="gpsImportModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üìç GPS Koordinatlarƒ±ndan ƒ∞√ße Aktar</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Alan Adƒ±:</label>
                            <input type="text" class="form-control" id="gpsAreaName" placeholder="√ñrn: GPS ile √ßizilen alan">
                        </div>

                        <div class="form-group">
                            <label>GPS Koordinatlarƒ±:</label>
                            <textarea class="form-control" id="gpsCoordinates" rows="8"
                                      placeholder="40.123456, 29.123456
40.123500, 29.123500
40.123600, 29.123400
40.123400, 29.123300"></textarea>
                            <small class="text-muted">
                                Her satƒ±ra bir GPS koordinatƒ± (enlem, boylam) yazƒ±n.<br>
                                Format: 40.123456, 29.123456
                            </small>
                        </div>

                        <div class="alert alert-info">
                            <strong>üí° ƒ∞pucu:</strong> GPS koordinatlarƒ±nƒ± Google Maps'ten kopyalayabilirsiniz.
                            Haritada saƒü tƒ±klayƒ±n ve koordinatlarƒ± kopyalayƒ±n.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">‚ùå ƒ∞ptal</button>
                        <button type="button" class="btn btn-primary" onclick="processGPSImport()">
                            üì• ƒ∞√ße Aktar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `);

        $('body').append(importModal);
        const modal = new bootstrap.Modal(document.getElementById('gpsImportModal'));
        modal.show();

        // Modal kapandƒ±ƒüƒ±nda temizle
        document.getElementById('gpsImportModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    // Zamanlama se√ßeneklerini g√∂ster/gizle
    const enableScheduleCheckbox = document.getElementById('enableSchedule');
    if (enableScheduleCheckbox) {
        enableScheduleCheckbox.addEventListener('change', function () {
            const scheduleOptions = document.getElementById('scheduleOptions');
            if (scheduleOptions) {
                if (this.checked) {
                    scheduleOptions.style.display = 'block';
                } else {
                    scheduleOptions.style.display = 'none';
                }
            }
        });
    }

    // Harita tƒ±klama olaylarƒ±
    document.getElementById('area-map').addEventListener('click', function (e) {
        if (currentMapMode === 'create') {
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Koordinat sistemi d√∂n√º≈ü√ºm√º (pixel -> metre)
            const realX = (x / rect.width) * 50; // 50m maksimum geni≈ülik
            const realY = (y / rect.height) * 30; // 30m maksimum y√ºkseklik

            newAreaPoints.push({ x: realX, y: realY, pixelX: x, pixelY: y });

            // Noktayƒ± g√∂rsel olarak ekle
            const point = document.createElement('div');
            point.className = 'area-point';
            point.style.left = x + 'px';
            point.style.top = y + 'px';
            point.style.background = '#ffc107';
            this.appendChild(point);

            if (newAreaPoints.length >= 3) {
                // Alan olu≈üturma tamamlanabilir
                const confirmCreate = confirm(`${newAreaPoints.length} nokta ile alan olu≈üturulsun mu?`);
                if (confirmCreate) {
                    createNewArea();
                }
            }
        }
    });

    // Yeni alan olu≈üturma
    function createNewArea() {
        const areaName = prompt('Alan adƒ±:', 'Yeni Alan');
        if (!areaName) return;

        if (newAreaPoints.length < 3) {
            showNotification('‚ùå En az 3 nokta gerekli', 'warning');
            return;
        }

        // Alan ID'si olu≈ütur
        const areaId = `area_${Date.now()}`;

        // Koordinatlarƒ± API formatƒ±na √ßevir
        const boundary = newAreaPoints.map(p => ({
            x: p.x,
            y: p.y
        }));

        const newAreaData = {
            id: areaId,
            name: areaName,
            boundary: boundary,
            pattern: 'lawn_mower',
            blade_height: 5,
            speed: 0.5,
            overlap: 0.1
        };

        // API'ye g√∂nder
        fetch('/api/areas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(newAreaData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Ba≈üarƒ±lƒ± olu≈üturma
                    showNotification('‚úÖ Yeni alan olu≈üturuldu!', 'success');

                    // Sayfayƒ± yenile veya yeni alan kartƒ±nƒ± dinamik ekle
                    addNewAreaCard(areaId, newAreaData);

                    // Temizle
                    newAreaPoints = [];
                    $('.area-point[style*="background: rgb(255, 193, 7)"]').remove();
                    setMapMode('view');

                    // ƒ∞statistikleri g√ºncelle
                    updateAreaStatistics();
                } else {
                    showNotification(`‚ùå Alan olu≈üturulamadƒ±: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Alan olu≈üturma hatasƒ±:', error);
                showNotification('‚ùå Baƒülantƒ± hatasƒ±', 'danger');
            });
    }

    // Haritada alan √ßizme
    function drawAreaOnMap(points) {
        if (points.length < 3) return;

        // Minimum ve maksimum koordinatlarƒ± bul
        const minX = Math.min(...points.map(p => p.pixelX));
        const minY = Math.min(...points.map(p => p.pixelY));
        const maxX = Math.max(...points.map(p => p.pixelX));
        const maxY = Math.max(...points.map(p => p.pixelY));

        const polygon = $('<div class="area-polygon"></div>');
        polygon.css({
            left: minX + 'px',
            top: minY + 'px',
            width: (maxX - minX) + 'px',
            height: (maxY - minY) + 'px',
            border: '2px solid #28a745',
            background: 'rgba(40, 167, 69, 0.1)'
        });

        $('#area-map').append(polygon);
    }

    // Haritada alan poligonu √ßiz
    function drawAreaPolygonOnMap(areaId, boundary) {
        if (!boundary || boundary.length < 3) return;

        // Alan sƒ±nƒ±rlarƒ±nƒ± hesapla
        const minX = Math.min(...boundary.map(p => p.x));
        const minY = Math.min(...boundary.map(p => p.y));
        const maxX = Math.max(...boundary.map(p => p.x));
        const maxY = Math.max(...boundary.map(p => p.y));

        // Harita boyutlarƒ±na g√∂re piksel koordinatlarƒ±na √ßevir
        const map = document.getElementById('area-map');
        const mapWidth = map.offsetWidth;
        const mapHeight = map.offsetHeight;

        // Koordinat d√∂n√º≈ü√ºm√º: Ger√ßek koordinat -> Piksel
        // X: 0-50m -> 0-mapWidth
        // Y: 0-40m -> 0-mapHeight
        const pixelMinX = (minX / 50) * mapWidth;
        const pixelMinY = (minY / 40) * mapHeight;
        const pixelMaxX = (maxX / 50) * mapWidth;
        const pixelMaxY = (maxY / 40) * mapHeight;

        // Poligon elementi olu≈ütur
        const polygon = document.createElement('div');
        polygon.className = 'area-polygon';
        polygon.setAttribute('data-area-id', areaId);
        polygon.style.position = 'absolute';
        polygon.style.left = pixelMinX + 'px';
        polygon.style.top = pixelMinY + 'px';
        polygon.style.width = (pixelMaxX - pixelMinX) + 'px';
        polygon.style.height = (pixelMaxY - pixelMinY) + 'px';
        polygon.style.border = '2px solid #007bff';
        polygon.style.background = 'rgba(0, 123, 255, 0.1)';
        polygon.style.borderRadius = '4px';
        polygon.style.cursor = 'pointer';
        polygon.title = `Alan: ${areaId}`;

        // Haritaya ekle
        map.appendChild(polygon);

        // Tƒ±klama eventi ekle
        polygon.addEventListener('click', function (e) {
            e.stopPropagation();
            showArea(areaId);
        });
    }

    // T√ºm alan poligonlarƒ±nƒ± temizle
    function clearMapPolygons() {
        const polygons = document.querySelectorAll('.area-polygon[data-area-id]');
        polygons.forEach(polygon => polygon.remove());
    }

    // Bildirim g√∂sterme
    function showNotification(message, type = 'info') {
        const alertClass = `alert-${type}`;
        const notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert"
             style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `);

        $('body').append(notification);

        // 5 saniye sonra otomatik kapat
        setTimeout(() => {
            notification.alert('close');
        }, 5000);
    }

    // Koordinat string'ini parse et
    function parseCoordinates(coordString) {
        const coords = [];
        const matches = coordString.match(/\(([^)]+)\)/g);

        if (!matches) {
            throw new Error('Ge√ßersiz koordinat formatƒ±');
        }

        matches.forEach(match => {
            const cleanMatch = match.replace(/[()]/g, '');
            const [x, y] = cleanMatch.split(',').map(s => parseFloat(s.trim()));

            if (isNaN(x) || isNaN(y)) {
                throw new Error('Ge√ßersiz koordinat deƒüerleri');
            }

            coords.push({ x, y });
        });

        if (coords.length < 3) {
            throw new Error('En az 3 koordinat gerekli');
        }

        return coords;
    }

    // Alan kartƒ±nƒ± g√ºncelle
    function updateAreaCard(areaId, areaData) {
        const card = $(`.area-card[data-area-id="${areaId}"]`);
        if (card.length) {
            card.find('h5').text(`üå± ${areaData.name}`);

            const area_m2 = calculateAreaSize(areaData.boundary);
            card.find('p.text-muted').text(`${area_m2.toFixed(0)} m¬≤ alan`);

            // ƒ∞statistikleri g√ºncelle
            const stats = card.find('.area-stats small');
            stats.html(`
            <strong>Bi√ßme Y√ºksekliƒüi:</strong> ${areaData.blade_height} cm<br>
            <strong>Hƒ±z:</strong> ${areaData.speed} m/s<br>
            <strong>Desen:</strong> ${getPatternName(areaData.pattern)}
        `);
        }
    }

    // Yeni alan kartƒ± ekle
    function addNewAreaCard(areaId, areaData) {
        const area_m2 = calculateAreaSize(areaData.boundary);

        const newAreaCard = $(`
        <div class="area-card" data-area-id="${areaId}">
            <div class="row">
                <div class="col-md-8">
                    <h5>üÜï ${areaData.name}</h5>
                    <p class="text-muted">${area_m2.toFixed(0)} m¬≤ alan</p>
                    <div class="area-stats">
                        <small>
                            <strong>Bi√ßme Y√ºksekliƒüi:</strong> ${areaData.blade_height} cm<br>
                            <strong>Hƒ±z:</strong> ${areaData.speed} m/s<br>
                            <strong>Desen:</strong> ${getPatternName(areaData.pattern)}<br>
                            <strong>Durum:</strong> Hen√ºz bi√ßilmedi
                        </small>
                    </div>
                </div>
                <div class="col-md-4 text-right">
                    <div class="btn-group-vertical">
                        <button class="btn btn-success btn-sm" onclick="startMowing('${areaId}')">
                            ‚úÇÔ∏è Bi√ß
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="editArea('${areaId}')">
                            ‚úèÔ∏è D√ºzenle
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="showArea('${areaId}')">
                            üëÅÔ∏è G√∂ster
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteArea('${areaId}')">
                            üóëÔ∏è Sil
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `);

        document.getElementById('area-list').appendChild(newAreaCard[0]);

        // Haritada poligon √ßiz
        drawAreaPolygonOnMap(areaId, areaData.boundary);
    }

    // Alan durumunu g√ºncelle
    function updateAreaStatus(areaId, status) {
        const card = $(`.area-card[data-area-id="${areaId}"]`);
        if (card.length) {
            const stats = card.find('.area-stats small');
            const currentText = stats.html();
            const updatedText = currentText.replace(
                /<strong>Durum:<\/strong>[^<]*/,
                `<strong>Durum:</strong> ${status}`
            );
            stats.html(updatedText);
        }
    }

    // Alan boyutu hesapla (basit √ßokgen alan form√ºl√º)
    function calculateAreaSize(boundary) {
        if (boundary.length < 3) return 0;

        let area = 0;
        for (let i = 0; i < boundary.length; i++) {
            const j = (i + 1) % boundary.length;
            area += boundary[i].x * boundary[j].y;
            area -= boundary[j].x * boundary[i].y;
        }
        return Math.abs(area) / 2;
    }

    // Desen adƒ±nƒ± getir
    function getPatternName(pattern) {
        const patterns = {
            'lawn_mower': 'Bi√ßerd√∂ver (Paralel)',
            'spiral': 'Spiral',
            'random': 'Rastgele',
            'perimeter_first': '√ñnce √áevre'
        };
        return patterns[pattern] || pattern;
    }

    // Alan istatistiklerini g√ºncelle
    function updateAreaStatistics() {
        fetch('/api/areas')
            .then(response => response.json())
            .then(data => {
                const areas = Object.values(data);
                let totalArea = 0;
                let totalTime = 0;

                areas.forEach(area => {
                    const area_m2 = calculateAreaSize(area.boundary);
                    totalArea += area_m2;
                    // Basit s√ºre hesaplamasƒ±: 1 m¬≤ = 1 dakika (yakla≈üƒ±k)
                    totalTime += area_m2 / 60; // saat
                });

                // ƒ∞statistik kartlarƒ±nƒ± g√ºncelle
                $('.col-6:contains("Tanƒ±mlƒ± Alan") h4').text(areas.length);
                $('.col-6:contains("Toplam Alan") h4').text(`${totalArea.toFixed(0)} m¬≤`);
                $('.col-6:contains("Toplam S√ºre") h4').text(`${Math.round(totalTime * 60)} dk`);
            })
            .catch(error => {
                console.error('ƒ∞statistik g√ºncelleme hatasƒ±:', error);
            });
    }

    // Sayfa y√ºklendiƒüinde
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Alan y√∂netimi sayfasƒ± y√ºklendi');

        // Alanlarƒ± y√ºkle
        loadAreas();

        // Zamanlama checkbox event'i - bu yukarda zaten tanƒ±mlandƒ±
    });

    // Alanlarƒ± y√ºkle
    function loadAreas() {
        fetch('/api/areas')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Alan y√ºkleme hatasƒ±:', data.error);
                    showNotification('‚ùå Alanlar y√ºklenemedi', 'danger');
                    return;
                }

                // Mevcut alan kartlarƒ±nƒ± ve harita poligonlarƒ±nƒ± temizle
                document.querySelectorAll('.area-card').forEach(card => card.remove());
                clearMapPolygons();

                // Her alanƒ± kartlara d√∂n√º≈üt√ºr (harita poligonlarƒ± da √ßizilecek)
                Object.entries(data).forEach(([areaId, areaData]) => {
                    addNewAreaCard(areaId, areaData);
                });

                // ƒ∞statistikleri g√ºncelle
                updateAreaStatistics();
            })
            .catch(error => {
                console.error('Alan y√ºkleme hatasƒ±:', error);
                showNotification('‚ö†Ô∏è Alan bilgileri y√ºklenirken sorun olu≈ütu', 'warning');
            });
    }

    // GPS import i≈ülemi
    function processGPSImport() {
        const areaName = $('#gpsAreaName').val().trim();
        const gpsCoords = $('#gpsCoordinates').val().trim();

        if (!areaName) {
            showNotification('‚ùå Alan adƒ± gerekli', 'warning');
            return;
        }

        if (!gpsCoords) {
            showNotification('‚ùå GPS koordinatlarƒ± gerekli', 'warning');
            return;
        }

        try {
            // GPS koordinatlarƒ±nƒ± parse et
            const lines = gpsCoords.split('\n');
            const boundary = [];

            lines.forEach((line, index) => {
                const cleanLine = line.trim();
                if (!cleanLine) return;

                const coords = cleanLine.split(',');
                if (coords.length !== 2) {
                    throw new Error(`Satƒ±r ${index + 1}: Ge√ßersiz koordinat formatƒ±`);
                }

                const lat = parseFloat(coords[0].trim());
                const lon = parseFloat(coords[1].trim());

                if (isNaN(lat) || isNaN(lon)) {
                    throw new Error(`Satƒ±r ${index + 1}: Ge√ßersiz koordinat deƒüerleri`);
                }

                // GPS koordinatlarƒ±nƒ± lokal koordinat sistemine √ßevir
                // Bu basit bir d√∂n√º≈ü√ºm - ger√ßek projede daha sofistike olabilir
                const localX = (lon - 29.0) * 111320 * Math.cos(lat * Math.PI / 180) / 1000; // km cinsinden
                const localY = (lat - 40.0) * 110540 / 1000; // km cinsinden

                boundary.push({ x: localX, y: localY });
            });

            if (boundary.length < 3) {
                throw new Error('En az 3 koordinat gerekli');
            }

            // Yeni alan olu≈ütur
            const areaId = `gps_area_${Date.now()}`;
            const newAreaData = {
                id: areaId,
                name: areaName,
                boundary: boundary,
                pattern: 'lawn_mower',
                blade_height: 5,
                speed: 0.4,
                overlap: 0.1
            };

            // API'ye g√∂nder
            fetch('/api/areas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newAreaData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('gpsImportModal'));
                        modal.hide();
                        showNotification('‚úÖ GPS koordinatlarƒ±ndan alan olu≈üturuldu!', 'success');

                        // Yeni alan kartƒ±nƒ± ekle
                        addNewAreaCard(areaId, newAreaData);
                        updateAreaStatistics();
                    } else {
                        showNotification(`‚ùå GPS alan olu≈üturulamadƒ±: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('GPS alan olu≈üturma hatasƒ±:', error);
                    showNotification('‚ùå Baƒülantƒ± hatasƒ±', 'danger');
                });

        } catch (error) {
            showNotification(`‚ùå GPS koordinat hatasƒ±: ${error.message}`, 'danger');
        }
    }

    // Bi√ßme durdurma fonksiyonu
    function stopMowing(areaId) {
        if (confirm(`${areaId} alanƒ±ndaki bi√ßme i≈ülemini durdurmak istiyor musunuz?`)) {
            fetch(`/api/areas/${areaId}/stop`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('‚èπÔ∏è Bi√ßme i≈ülemi durduruldu!', 'warning');
                        updateAreaStatus(areaId, 'Durduruldu');
                    } else {
                        showNotification(`‚ùå Bi√ßme durdurulamadƒ±: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Bi√ßme durdurma hatasƒ±:', error);
                    showNotification('‚ùå Baƒülantƒ± hatasƒ±', 'danger');
                });
        }
    }
</script>
{% endblock %}
