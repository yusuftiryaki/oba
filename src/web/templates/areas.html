{% extends "base.html" %}

{% block title %}Alan YÃ¶netimi - OBA Robot{% endblock %}

{% block extra_css %}
<style>
    .area-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: #f9f9f9;
    }

    .area-map {
        width: 100%;
        height: 300px;
        border: 1px solid #ccc;
        background: #f0f0f0;
        position: relative;
        cursor: crosshair;
    }

    .area-point {
        position: absolute;
        width: 8px;
        height: 8px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
        transform: translate(-50%, -50%);
    }

    .area-polygon {
        position: absolute;
        border: 2px solid #007bff;
        background: rgba(0, 123, 255, 0.1);
        pointer-events: none;
    }

    .btn-group {
        margin-bottom: 10px;
    }

    .area-stats {
        background: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
        }
    }

    .area-highlight {
        pointer-events: none;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <h2>ğŸï¸ Ã‡alÄ±ÅŸma AlanlarÄ±</h2>

            <!-- Alan Listesi -->
            <div id="area-list">
                <!-- Dinamik alan kartlarÄ± buraya JavaScript ile yÃ¼klenecek -->
            </div>

            <!-- Yeni Alan Ekleme -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5>â• Yeni Alan Ekle</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary" onclick="startAreaCreation()">
                        ğŸ—ºï¸ Harita Ãœzerinde Ã‡iz
                    </button>
                    <button class="btn btn-secondary ml-2" onclick="importFromGPS()">
                        ğŸ“ GPS KoordinatlarÄ±ndan Ä°Ã§e Aktar
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Harita/Planlama Paneli -->
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ—ºï¸ Alan HaritasÄ±</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" onclick="setMapMode('view')">
                            ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼le
                        </button>
                        <button class="btn btn-outline-primary" onclick="setMapMode('edit')">
                            âœï¸ DÃ¼zenle
                        </button>
                        <button class="btn btn-outline-primary" onclick="setMapMode('create')">
                            â• OluÅŸtur
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="area-map" id="area-map">
                        <!-- Dinamik alan gÃ¶rselleÅŸtirmeleri buraya JavaScript ile eklenecek -->

                        <!-- Robot pozisyonu -->
                        <div class="area-point" style="left: 50%; top: 50%; background: #dc3545;"
                            title="Robot Pozisyonu"></div>

                        <!-- Åarj istasyonu -->
                        <div class="area-point" style="left: 10%; top: 10%; background: #28a745;"
                            title="Åarj Ä°stasyonu"></div>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>AÃ§Ä±klama:</strong><br>
                            ğŸŸ¦ Mavi: TanÄ±mlÄ± alanlar<br>
                            ğŸ”´ KÄ±rmÄ±zÄ±: Robot pozisyonu<br>
                            ğŸŸ¢ YeÅŸil: Åarj istasyonu<br>
                            Haritaya tÄ±klayarak yeni alan oluÅŸturabilirsiniz.
                        </small>
                    </div>
                </div>
            </div>

            <!-- Alan Ä°statistikleri -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5>ğŸ“Š Alan Ä°statistikleri</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">2</h4>
                            <small>TanÄ±mlÄ± Alan</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">975 mÂ²</h4>
                            <small>Toplam Alan</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-info">75 dk</h4>
                            <small>Toplam SÃ¼re</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning">20</h4>
                            <small>Toplam BiÃ§im</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alan DÃ¼zenleme Modal -->
<div class="modal fade" id="editAreaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">âœï¸ Alan DÃ¼zenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body">
                <form id="editAreaForm">
                    <div class="form-group">
                        <label>Alan AdÄ±:</label>
                        <input type="text" class="form-control" id="areaName" placeholder="Ã–rn: DoÄŸu BahÃ§e">
                    </div>

                    <div class="form-group">
                        <label>BiÃ§me AyarlarÄ±:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="small">BiÃ§me YÃ¼ksekliÄŸi (cm):</label>
                                <select class="form-control" id="cuttingHeight">
                                    <option value="3">3 cm (En DÃ¼ÅŸÃ¼k)</option>
                                    <option value="5" selected>5 cm (Normal)</option>
                                    <option value="7">7 cm (Orta)</option>
                                    <option value="10">10 cm (YÃ¼ksek)</option>
                                    <option value="12">12 cm (En YÃ¼ksek)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="small">HÄ±z:</label>
                                <select class="form-control" id="mowingSpeed">
                                    <option value="0.2">YavaÅŸ (0.2 m/s)</option>
                                    <option value="0.4" selected>Normal (0.4 m/s)</option>
                                    <option value="0.6">HÄ±zlÄ± (0.6 m/s)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>BiÃ§me DÃ¼zeni:</label>
                        <select class="form-control" id="mowingPattern">
                            <option value="lawn_mower" selected>BiÃ§erdÃ¶ver (Paralel)</option>
                            <option value="spiral">Spiral</option>
                            <option value="random">Rastgele</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Koordinatlar:</label>
                        <textarea class="form-control" id="areaCoordinates" rows="4"
                            placeholder="(0,0), (30,0), (30,20), (0,20)"></textarea>
                        <small class="text-muted">Her satÄ±ra bir koordinat Ã§ifti (x,y) yazÄ±n</small>
                    </div>

                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="enableSchedule">
                            <label class="custom-control-label" for="enableSchedule">
                                Otomatik Zamanlama
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="scheduleOptions" style="display: none;">
                        <label>Zamanlama:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-control" id="scheduleFrequency">
                                    <option value="daily">GÃ¼nlÃ¼k</option>
                                    <option value="weekly" selected>HaftalÄ±k</option>
                                    <option value="monthly">AylÄ±k</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <input type="time" class="form-control" id="scheduleTime" value="09:00">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    âŒ Ä°ptal
                </button>
                <button type="button" class="btn btn-primary" onclick="saveArea()">
                    âœ… Kaydet
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentMapMode = 'view';
    let selectedArea = null;
    let newAreaPoints = [];

    // Harita modu deÄŸiÅŸtirme
    function setMapMode(mode) {
        currentMapMode = mode;
        $('.btn-group .btn').removeClass('active');
        $(`button[onclick="setMapMode('${mode}')"]`).addClass('active');

        const map = document.getElementById('area-map');

        switch (mode) {
            case 'view':
                map.style.cursor = 'default';
                break;
            case 'edit':
                map.style.cursor = 'grab';
                break;
            case 'create':
                map.style.cursor = 'crosshair';
                newAreaPoints = [];
                break;
        }
    }

    // Alan biÃ§me baÅŸlatma
    function startMowing(areaId) {
        if (confirm(`${areaId} alanÄ±nda biÃ§me iÅŸlemini baÅŸlatmak istiyor musunuz?`)) {
            // GerÃ§ek API Ã§aÄŸrÄ±sÄ±
            fetch(`/api/areas/${areaId}/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('ğŸš€ BiÃ§me iÅŸlemi baÅŸlatÄ±ldÄ±!', 'success');
                        // Alan kartÄ±ndaki durumu gÃ¼ncelle
                        updateAreaStatus(areaId, 'BiÃ§iliyor');
                    } else {
                        showNotification(`âŒ BiÃ§me baÅŸlatÄ±lamadÄ±: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('BiÃ§me baÅŸlatma hatasÄ±:', error);
                    showNotification('âŒ BaÄŸlantÄ± hatasÄ±', 'danger');
                });
        }
    }

    // Alan dÃ¼zenleme
    function editArea(areaId) {
        selectedArea = areaId;

        // GerÃ§ek API'den alan bilgilerini yÃ¼kle
        fetch(`/api/areas/${areaId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(`âŒ Alan bulunamadÄ±: ${data.error}`, 'danger');
                    return;
                }

                // Modal'daki form alanlarÄ±nÄ± doldur
                document.getElementById('areaName').value = data.name;
                document.getElementById('cuttingHeight').value = data.blade_height;
                document.getElementById('mowingSpeed').value = data.speed;
                document.getElementById('mowingPattern').value = data.pattern;

                // KoordinatlarÄ± string formatÄ±na Ã§evir
                const coordString = data.boundary.map(p =>
                    `(${p.x.toFixed(1)},${p.y.toFixed(1)})`
                ).join(', ');
                document.getElementById('areaCoordinates').value = coordString;

                // Modal'Ä± gÃ¶ster
                const modal = new bootstrap.Modal(document.getElementById('editAreaModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Alan yÃ¼kleme hatasÄ±:', error);
                showNotification('âŒ Alan bilgileri yÃ¼klenemedi', 'danger');
            });
    }

    // Alan gÃ¶sterme/gizleme
    function showArea(areaId) {
        // Alan kartÄ±nÄ± vurgula
        $('.area-card').removeClass('border-primary');
        const areaCard = $(`.area-card[data-area-id="${areaId}"]`);
        areaCard.addClass('border-primary');

        // Alan bilgilerini API'den getir
        fetch(`/api/areas/${areaId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(`âŒ Alan bulunamadÄ±: ${data.error}`, 'danger');
                    return;
                }

                // Haritada alanÄ± vurgula
                highlightAreaOnMap(data.boundary);

                // Alan detay bilgilerini gÃ¶ster
                showAreaDetails(data);
            })
            .catch(error => {
                console.error('Alan gÃ¶sterme hatasÄ±:', error);
                showNotification('âŒ Alan bilgileri yÃ¼klenemedi', 'danger');
            });
    }

    // Haritada alanÄ± vurgula
    function highlightAreaOnMap(boundary) {
        // Ã–nce eski vurgularÄ± temizle
        $('.area-highlight').remove();

        if (boundary.length < 3) return;

        // Alan sÄ±nÄ±rlarÄ±nÄ± hesapla
        const minX = Math.min(...boundary.map(p => p.x));
        const minY = Math.min(...boundary.map(p => p.y));
        const maxX = Math.max(...boundary.map(p => p.x));
        const maxY = Math.max(...boundary.map(p => p.y));

        // Harita boyutlarÄ±na gÃ¶re piksel koordinatlarÄ±na Ã§evir
        const mapWidth = $('#area-map').width();
        const mapHeight = $('#area-map').height();

        const pixelMinX = (minX / 50) * mapWidth;
        const pixelMinY = (minY / 30) * mapHeight;
        const pixelMaxX = (maxX / 50) * mapWidth;
        const pixelMaxY = (maxY / 30) * mapHeight;

        // Vurgulama alanÄ± oluÅŸtur
        const highlight = $('<div class="area-highlight"></div>');
        highlight.css({
            position: 'absolute',
            left: pixelMinX + 'px',
            top: pixelMinY + 'px',
            width: (pixelMaxX - pixelMinX) + 'px',
            height: (pixelMaxY - pixelMinY) + 'px',
            border: '3px solid #ffc107',
            background: 'rgba(255, 193, 7, 0.2)',
            borderRadius: '4px',
            animation: 'pulse 2s infinite'
        });

        $('#area-map').append(highlight);

        // 5 saniye sonra vurguyu kaldÄ±r
        setTimeout(() => {
            highlight.fadeOut(() => highlight.remove());
        }, 5000);
    }

    // Alan detaylarÄ±nÄ± gÃ¶ster
    function showAreaDetails(areaData) {
        const area_m2 = calculateAreaSize(areaData.boundary);
        const estimatedTime = Math.round(area_m2 / 100); // 100 mÂ²/dk varsayÄ±mÄ±

        // EÄŸer zaten varsa Ã¶nceki modal'Ä± temizle
        const existingModal = document.getElementById('areaDetailModal');
        if (existingModal) {
            existingModal.remove();
        }

        const modalHTML = `
        <div class="modal fade" id="areaDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ğŸ“‹ ${areaData.name} - Alan DetaylarÄ±</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>ğŸ“ Alan Bilgileri</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Alan:</strong> ${area_m2.toFixed(1)} mÂ²</li>
                                    <li><strong>Nokta SayÄ±sÄ±:</strong> ${areaData.boundary.length}</li>
                                    <li><strong>Desen:</strong> ${getPatternName(areaData.pattern)}</li>
                                    <li><strong>Tahmini SÃ¼re:</strong> ${estimatedTime} dakika</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>âš™ï¸ BiÃ§me AyarlarÄ±</h6>
                                <ul class="list-unstyled">
                                    <li><strong>BÄ±Ã§ak YÃ¼ksekliÄŸi:</strong> ${areaData.blade_height} cm</li>
                                    <li><strong>HÄ±z:</strong> ${areaData.speed} m/s</li>
                                    <li><strong>Overlap:</strong> ${(areaData.overlap * 100).toFixed(0)}%</li>
                                </ul>
                            </div>
                        </div>

                        <hr>

                        <h6>ğŸ“ Koordinatlar</h6>
                        <div style="max-height: 150px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Nokta</th>
                                        <th>X (m)</th>
                                        <th>Y (m)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${areaData.boundary.map((point, index) => `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>${point.x.toFixed(2)}</td>
                                            <td>${point.y.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="startMowing('${areaData.id}'); closeAreaDetailModal();">
                            âœ‚ï¸ BiÃ§meye BaÅŸla
                        </button>
                        <button type="button" class="btn btn-primary" onclick="editArea('${areaData.id}'); closeAreaDetailModal();">
                            âœï¸ DÃ¼zenle
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">âŒ Kapat</button>
                    </div>
                </div>
            </div>
        </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('areaDetailModal'));
        modal.show();

        // Modal kapandÄ±ÄŸÄ±nda temizle
        document.getElementById('areaDetailModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
            document.querySelectorAll('.area-card').forEach(card => {
                card.classList.remove('border-primary');
            });
        });
    }

    // Alan detay modalÄ±nÄ± kapat yardÄ±mcÄ± fonksiyonu
    function closeAreaDetailModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('areaDetailModal'));
        if (modal) {
            modal.hide();
        }
    }

    // Alan silme
    function deleteArea(areaId) {
        if (confirm('Bu alanÄ± silmek istediÄŸinizden emin misiniz?')) {
            fetch(`/api/areas/${areaId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Alan kartÄ±nÄ± kaldÄ±r
                        $(`.area-card[data-area-id="${areaId}"]`).fadeOut(() => {
                            $(this).remove();
                        });
                        showNotification('ğŸ—‘ï¸ Alan silindi', 'warning');
                        // Sayfa istatistiklerini gÃ¼ncelle
                        updateAreaStatistics();
                    } else {
                        showNotification(`âŒ Alan silinemedi: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Alan silme hatasÄ±:', error);
                    showNotification('âŒ BaÄŸlantÄ± hatasÄ±', 'danger');
                });
        }
    }

    // Alan kaydetme
    function saveArea() {
        const areaName = document.getElementById('areaName').value.trim();
        const coordinates = document.getElementById('areaCoordinates').value.trim();

        if (!areaName) {
            showNotification('âŒ Alan adÄ± gerekli', 'warning');
            return;
        }

        if (!coordinates) {
            showNotification('âŒ Koordinatlar gerekli', 'warning');
            return;
        }

        // KoordinatlarÄ± parse et
        let boundary;
        try {
            boundary = parseCoordinates(coordinates);
        } catch (error) {
            showNotification('âŒ GeÃ§ersiz koordinat formatÄ±', 'warning');
            return;
        }

        const areaData = {
            name: areaName,
            blade_height: parseInt(document.getElementById('cuttingHeight').value),
            speed: parseFloat(document.getElementById('mowingSpeed').value),
            pattern: document.getElementById('mowingPattern').value,
            boundary: boundary,
            overlap: 0.1
        };

        // API'ye gÃ¶nder
        fetch(`/api/areas/${selectedArea}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(areaData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editAreaModal'));
                    modal.hide();
                    showNotification('âœ… Alan ayarlarÄ± kaydedildi', 'success');
                    // Sayfa yenilenmeden alan kartÄ±nÄ± gÃ¼ncelle
                    updateAreaCard(selectedArea, areaData);
                } else {
                    showNotification(`âŒ Kaydetme hatasÄ±: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Alan kaydetme hatasÄ±:', error);
                showNotification('âŒ BaÄŸlantÄ± hatasÄ±', 'danger');
            });
    }

    // Yeni alan oluÅŸturma baÅŸlatma
    function startAreaCreation() {
        setMapMode('create');
        showNotification('ğŸ—ºï¸ Harita Ã¼zerinde alan sÄ±nÄ±rlarÄ±nÄ± Ã§izin', 'info');
    }

    // GPS iÃ§e aktarma
    function importFromGPS() {
        // GPS koordinat iÃ§e aktarma modalÄ±nÄ± oluÅŸtur ve gÃ¶ster
        const importModal = $(`
        <div class="modal fade" id="gpsImportModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ğŸ“ GPS KoordinatlarÄ±ndan Ä°Ã§e Aktar</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Alan AdÄ±:</label>
                            <input type="text" class="form-control" id="gpsAreaName" placeholder="Ã–rn: GPS ile Ã§izilen alan">
                        </div>

                        <div class="form-group">
                            <label>GPS KoordinatlarÄ±:</label>
                            <textarea class="form-control" id="gpsCoordinates" rows="8"
                                      placeholder="40.123456, 29.123456
40.123500, 29.123500
40.123600, 29.123400
40.123400, 29.123300"></textarea>
                            <small class="text-muted">
                                Her satÄ±ra bir GPS koordinatÄ± (enlem, boylam) yazÄ±n.<br>
                                Format: 40.123456, 29.123456
                            </small>
                        </div>

                        <div class="alert alert-info">
                            <strong>ğŸ’¡ Ä°pucu:</strong> GPS koordinatlarÄ±nÄ± Google Maps'ten kopyalayabilirsiniz.
                            Haritada saÄŸ tÄ±klayÄ±n ve koordinatlarÄ± kopyalayÄ±n.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">âŒ Ä°ptal</button>
                        <button type="button" class="btn btn-primary" onclick="processGPSImport()">
                            ğŸ“¥ Ä°Ã§e Aktar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `);

        $('body').append(importModal);
        const modal = new bootstrap.Modal(document.getElementById('gpsImportModal'));
        modal.show();

        // Modal kapandÄ±ÄŸÄ±nda temizle
        document.getElementById('gpsImportModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    // Zamanlama seÃ§eneklerini gÃ¶ster/gizle
    const enableScheduleCheckbox = document.getElementById('enableSchedule');
    if (enableScheduleCheckbox) {
        enableScheduleCheckbox.addEventListener('change', function () {
            const scheduleOptions = document.getElementById('scheduleOptions');
            if (scheduleOptions) {
                if (this.checked) {
                    scheduleOptions.style.display = 'block';
                } else {
                    scheduleOptions.style.display = 'none';
                }
            }
        });
    }

    // Harita tÄ±klama olaylarÄ±
    document.getElementById('area-map').addEventListener('click', function (e) {
        if (currentMapMode === 'create') {
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Koordinat sistemi dÃ¶nÃ¼ÅŸÃ¼mÃ¼ (pixel -> metre)
            const realX = (x / rect.width) * 50; // 50m maksimum geniÅŸlik
            const realY = (y / rect.height) * 30; // 30m maksimum yÃ¼kseklik

            newAreaPoints.push({ x: realX, y: realY, pixelX: x, pixelY: y });

            // NoktayÄ± gÃ¶rsel olarak ekle
            const point = document.createElement('div');
            point.className = 'area-point';
            point.style.left = x + 'px';
            point.style.top = y + 'px';
            point.style.background = '#ffc107';
            this.appendChild(point);

            if (newAreaPoints.length >= 3) {
                // Alan oluÅŸturma tamamlanabilir
                const confirmCreate = confirm(`${newAreaPoints.length} nokta ile alan oluÅŸturulsun mu?`);
                if (confirmCreate) {
                    createNewArea();
                }
            }
        }
    });

    // Yeni alan oluÅŸturma
    function createNewArea() {
        const areaName = prompt('Alan adÄ±:', 'Yeni Alan');
        if (!areaName) return;

        if (newAreaPoints.length < 3) {
            showNotification('âŒ En az 3 nokta gerekli', 'warning');
            return;
        }

        // Alan ID'si oluÅŸtur
        const areaId = `area_${Date.now()}`;

        // KoordinatlarÄ± API formatÄ±na Ã§evir
        const boundary = newAreaPoints.map(p => ({
            x: p.x,
            y: p.y
        }));

        const newAreaData = {
            id: areaId,
            name: areaName,
            boundary: boundary,
            pattern: 'lawn_mower',
            blade_height: 5,
            speed: 0.5,
            overlap: 0.1
        };

        // API'ye gÃ¶nder
        fetch('/api/areas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(newAreaData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // BaÅŸarÄ±lÄ± oluÅŸturma
                    showNotification('âœ… Yeni alan oluÅŸturuldu!', 'success');

                    // SayfayÄ± yenile veya yeni alan kartÄ±nÄ± dinamik ekle
                    addNewAreaCard(areaId, newAreaData);

                    // Temizle
                    newAreaPoints = [];
                    $('.area-point[style*="background: rgb(255, 193, 7)"]').remove();
                    setMapMode('view');

                    // Ä°statistikleri gÃ¼ncelle
                    updateAreaStatistics();
                } else {
                    showNotification(`âŒ Alan oluÅŸturulamadÄ±: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Alan oluÅŸturma hatasÄ±:', error);
                showNotification('âŒ BaÄŸlantÄ± hatasÄ±', 'danger');
            });
    }

    // Haritada alan Ã§izme
    function drawAreaOnMap(points) {
        if (points.length < 3) return;

        // Minimum ve maksimum koordinatlarÄ± bul
        const minX = Math.min(...points.map(p => p.pixelX));
        const minY = Math.min(...points.map(p => p.pixelY));
        const maxX = Math.max(...points.map(p => p.pixelX));
        const maxY = Math.max(...points.map(p => p.pixelY));

        const polygon = $('<div class="area-polygon"></div>');
        polygon.css({
            left: minX + 'px',
            top: minY + 'px',
            width: (maxX - minX) + 'px',
            height: (maxY - minY) + 'px',
            border: '2px solid #28a745',
            background: 'rgba(40, 167, 69, 0.1)'
        });

        $('#area-map').append(polygon);
    }

    // Haritada alan poligonu Ã§iz
    function drawAreaPolygonOnMap(areaId, boundary) {
        if (!boundary || boundary.length < 3) return;

        // Alan sÄ±nÄ±rlarÄ±nÄ± hesapla
        const minX = Math.min(...boundary.map(p => p.x));
        const minY = Math.min(...boundary.map(p => p.y));
        const maxX = Math.max(...boundary.map(p => p.x));
        const maxY = Math.max(...boundary.map(p => p.y));

        // Harita boyutlarÄ±na gÃ¶re piksel koordinatlarÄ±na Ã§evir
        const map = document.getElementById('area-map');
        const mapWidth = map.offsetWidth;
        const mapHeight = map.offsetHeight;

        // Koordinat dÃ¶nÃ¼ÅŸÃ¼mÃ¼: GerÃ§ek koordinat -> Piksel
        // X: 0-50m -> 0-mapWidth
        // Y: 0-40m -> 0-mapHeight
        const pixelMinX = (minX / 50) * mapWidth;
        const pixelMinY = (minY / 40) * mapHeight;
        const pixelMaxX = (maxX / 50) * mapWidth;
        const pixelMaxY = (maxY / 40) * mapHeight;

        // Poligon elementi oluÅŸtur
        const polygon = document.createElement('div');
        polygon.className = 'area-polygon';
        polygon.setAttribute('data-area-id', areaId);
        polygon.style.position = 'absolute';
        polygon.style.left = pixelMinX + 'px';
        polygon.style.top = pixelMinY + 'px';
        polygon.style.width = (pixelMaxX - pixelMinX) + 'px';
        polygon.style.height = (pixelMaxY - pixelMinY) + 'px';
        polygon.style.border = '2px solid #007bff';
        polygon.style.background = 'rgba(0, 123, 255, 0.1)';
        polygon.style.borderRadius = '4px';
        polygon.style.cursor = 'pointer';
        polygon.title = `Alan: ${areaId}`;

        // Haritaya ekle
        map.appendChild(polygon);

        // TÄ±klama eventi ekle
        polygon.addEventListener('click', function (e) {
            e.stopPropagation();
            showArea(areaId);
        });
    }

    // TÃ¼m alan poligonlarÄ±nÄ± temizle
    function clearMapPolygons() {
        const polygons = document.querySelectorAll('.area-polygon[data-area-id]');
        polygons.forEach(polygon => polygon.remove());
    }

    // Bildirim gÃ¶sterme
    function showNotification(message, type = 'info') {
        const alertClass = `alert-${type}`;
        const notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert"
             style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `);

        $('body').append(notification);

        // 5 saniye sonra otomatik kapat
        setTimeout(() => {
            notification.alert('close');
        }, 5000);
    }

    // Koordinat string'ini parse et
    function parseCoordinates(coordString) {
        const coords = [];
        const matches = coordString.match(/\(([^)]+)\)/g);

        if (!matches) {
            throw new Error('GeÃ§ersiz koordinat formatÄ±');
        }

        matches.forEach(match => {
            const cleanMatch = match.replace(/[()]/g, '');
            const [x, y] = cleanMatch.split(',').map(s => parseFloat(s.trim()));

            if (isNaN(x) || isNaN(y)) {
                throw new Error('GeÃ§ersiz koordinat deÄŸerleri');
            }

            coords.push({ x, y });
        });

        if (coords.length < 3) {
            throw new Error('En az 3 koordinat gerekli');
        }

        return coords;
    }

    // Alan kartÄ±nÄ± gÃ¼ncelle
    function updateAreaCard(areaId, areaData) {
        const card = $(`.area-card[data-area-id="${areaId}"]`);
        if (card.length) {
            card.find('h5').text(`ğŸŒ± ${areaData.name}`);

            const area_m2 = calculateAreaSize(areaData.boundary);
            card.find('p.text-muted').text(`${area_m2.toFixed(0)} mÂ² alan`);

            // Ä°statistikleri gÃ¼ncelle
            const stats = card.find('.area-stats small');
            stats.html(`
            <strong>BiÃ§me YÃ¼ksekliÄŸi:</strong> ${areaData.blade_height} cm<br>
            <strong>HÄ±z:</strong> ${areaData.speed} m/s<br>
            <strong>Desen:</strong> ${getPatternName(areaData.pattern)}
        `);
        }
    }

    // Yeni alan kartÄ± ekle
    function addNewAreaCard(areaId, areaData) {
        const area_m2 = calculateAreaSize(areaData.boundary);

        const newAreaCard = $(`
        <div class="area-card" data-area-id="${areaId}">
            <div class="row">
                <div class="col-md-8">
                    <h5>ğŸ†• ${areaData.name}</h5>
                    <p class="text-muted">${area_m2.toFixed(0)} mÂ² alan</p>
                    <div class="area-stats">
                        <small>
                            <strong>BiÃ§me YÃ¼ksekliÄŸi:</strong> ${areaData.blade_height} cm<br>
                            <strong>HÄ±z:</strong> ${areaData.speed} m/s<br>
                            <strong>Desen:</strong> ${getPatternName(areaData.pattern)}<br>
                            <strong>Durum:</strong> HenÃ¼z biÃ§ilmedi
                        </small>
                    </div>
                </div>
                <div class="col-md-4 text-right">
                    <div class="btn-group-vertical">
                        <button class="btn btn-success btn-sm" onclick="startMowing('${areaId}')">
                            âœ‚ï¸ BiÃ§
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="editArea('${areaId}')">
                            âœï¸ DÃ¼zenle
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="showArea('${areaId}')">
                            ğŸ‘ï¸ GÃ¶ster
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteArea('${areaId}')">
                            ğŸ—‘ï¸ Sil
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `);

        document.getElementById('area-list').appendChild(newAreaCard[0]);

        // Haritada poligon Ã§iz
        drawAreaPolygonOnMap(areaId, areaData.boundary);
    }

    // Alan durumunu gÃ¼ncelle
    function updateAreaStatus(areaId, status) {
        const card = $(`.area-card[data-area-id="${areaId}"]`);
        if (card.length) {
            const stats = card.find('.area-stats small');
            const currentText = stats.html();
            const updatedText = currentText.replace(
                /<strong>Durum:<\/strong>[^<]*/,
                `<strong>Durum:</strong> ${status}`
            );
            stats.html(updatedText);
        }
    }

    // Alan boyutu hesapla (basit Ã§okgen alan formÃ¼lÃ¼)
    function calculateAreaSize(boundary) {
        if (boundary.length < 3) return 0;

        let area = 0;
        for (let i = 0; i < boundary.length; i++) {
            const j = (i + 1) % boundary.length;
            area += boundary[i].x * boundary[j].y;
            area -= boundary[j].x * boundary[i].y;
        }
        return Math.abs(area) / 2;
    }

    // Desen adÄ±nÄ± getir
    function getPatternName(pattern) {
        const patterns = {
            'lawn_mower': 'BiÃ§erdÃ¶ver (Paralel)',
            'spiral': 'Spiral',
            'random': 'Rastgele',
            'perimeter_first': 'Ã–nce Ã‡evre'
        };
        return patterns[pattern] || pattern;
    }

    // Alan istatistiklerini gÃ¼ncelle
    function updateAreaStatistics() {
        fetch('/api/areas')
            .then(response => response.json())
            .then(data => {
                const areas = Object.values(data);
                let totalArea = 0;
                let totalTime = 0;

                areas.forEach(area => {
                    const area_m2 = calculateAreaSize(area.boundary);
                    totalArea += area_m2;
                    // Basit sÃ¼re hesaplamasÄ±: 1 mÂ² = 1 dakika (yaklaÅŸÄ±k)
                    totalTime += area_m2 / 60; // saat
                });

                // Ä°statistik kartlarÄ±nÄ± gÃ¼ncelle
                $('.col-6:contains("TanÄ±mlÄ± Alan") h4').text(areas.length);
                $('.col-6:contains("Toplam Alan") h4').text(`${totalArea.toFixed(0)} mÂ²`);
                $('.col-6:contains("Toplam SÃ¼re") h4').text(`${Math.round(totalTime * 60)} dk`);
            })
            .catch(error => {
                console.error('Ä°statistik gÃ¼ncelleme hatasÄ±:', error);
            });
    }

    // Sayfa yÃ¼klendiÄŸinde
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Alan yÃ¶netimi sayfasÄ± yÃ¼klendi');

        // AlanlarÄ± yÃ¼kle
        loadAreas();

        // Zamanlama checkbox event'i - bu yukarda zaten tanÄ±mlandÄ±
    });

    // AlanlarÄ± yÃ¼kle
    function loadAreas() {
        fetch('/api/areas')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Alan yÃ¼kleme hatasÄ±:', data.error);
                    showNotification('âŒ Alanlar yÃ¼klenemedi', 'danger');
                    return;
                }

                // Mevcut alan kartlarÄ±nÄ± ve harita poligonlarÄ±nÄ± temizle
                document.querySelectorAll('.area-card').forEach(card => card.remove());
                clearMapPolygons();

                // Her alanÄ± kartlara dÃ¶nÃ¼ÅŸtÃ¼r (harita poligonlarÄ± da Ã§izilecek)
                Object.entries(data).forEach(([areaId, areaData]) => {
                    addNewAreaCard(areaId, areaData);
                });

                // Ä°statistikleri gÃ¼ncelle
                updateAreaStatistics();
            })
            .catch(error => {
                console.error('Alan yÃ¼kleme hatasÄ±:', error);
                showNotification('âš ï¸ Alan bilgileri yÃ¼klenirken sorun oluÅŸtu', 'warning');
            });
    }

    // GPS import iÅŸlemi
    function processGPSImport() {
        const areaName = $('#gpsAreaName').val().trim();
        const gpsCoords = $('#gpsCoordinates').val().trim();

        if (!areaName) {
            showNotification('âŒ Alan adÄ± gerekli', 'warning');
            return;
        }

        if (!gpsCoords) {
            showNotification('âŒ GPS koordinatlarÄ± gerekli', 'warning');
            return;
        }

        try {
            // GPS koordinatlarÄ±nÄ± parse et
            const lines = gpsCoords.split('\n');
            const boundary = [];

            lines.forEach((line, index) => {
                const cleanLine = line.trim();
                if (!cleanLine) return;

                const coords = cleanLine.split(',');
                if (coords.length !== 2) {
                    throw new Error(`SatÄ±r ${index + 1}: GeÃ§ersiz koordinat formatÄ±`);
                }

                const lat = parseFloat(coords[0].trim());
                const lon = parseFloat(coords[1].trim());

                if (isNaN(lat) || isNaN(lon)) {
                    throw new Error(`SatÄ±r ${index + 1}: GeÃ§ersiz koordinat deÄŸerleri`);
                }

                // GPS koordinatlarÄ±nÄ± lokal koordinat sistemine Ã§evir
                // Bu basit bir dÃ¶nÃ¼ÅŸÃ¼m - gerÃ§ek projede daha sofistike olabilir
                const localX = (lon - 29.0) * 111320 * Math.cos(lat * Math.PI / 180) / 1000; // km cinsinden
                const localY = (lat - 40.0) * 110540 / 1000; // km cinsinden

                boundary.push({ x: localX, y: localY });
            });

            if (boundary.length < 3) {
                throw new Error('En az 3 koordinat gerekli');
            }

            // Yeni alan oluÅŸtur
            const areaId = `gps_area_${Date.now()}`;
            const newAreaData = {
                id: areaId,
                name: areaName,
                boundary: boundary,
                pattern: 'lawn_mower',
                blade_height: 5,
                speed: 0.4,
                overlap: 0.1
            };

            // API'ye gÃ¶nder
            fetch('/api/areas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newAreaData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('gpsImportModal'));
                        modal.hide();
                        showNotification('âœ… GPS koordinatlarÄ±ndan alan oluÅŸturuldu!', 'success');

                        // Yeni alan kartÄ±nÄ± ekle
                        addNewAreaCard(areaId, newAreaData);
                        updateAreaStatistics();
                    } else {
                        showNotification(`âŒ GPS alan oluÅŸturulamadÄ±: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('GPS alan oluÅŸturma hatasÄ±:', error);
                    showNotification('âŒ BaÄŸlantÄ± hatasÄ±', 'danger');
                });

        } catch (error) {
            showNotification(`âŒ GPS koordinat hatasÄ±: ${error.message}`, 'danger');
        }
    }

    // BiÃ§me durdurma fonksiyonu
    function stopMowing(areaId) {
        if (confirm(`${areaId} alanÄ±ndaki biÃ§me iÅŸlemini durdurmak istiyor musunuz?`)) {
            fetch(`/api/areas/${areaId}/stop`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('â¹ï¸ BiÃ§me iÅŸlemi durduruldu!', 'warning');
                        updateAreaStatus(areaId, 'Durduruldu');
                    } else {
                        showNotification(`âŒ BiÃ§me durdurulamadÄ±: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('BiÃ§me durdurma hatasÄ±:', error);
                    showNotification('âŒ BaÄŸlantÄ± hatasÄ±', 'danger');
                });
        }
    }
</script>
{% endblock %}
