{% extends "base.html" %}

{% block title %}Alan YÃ¶netimi - OBA Robot{% endblock %}

{% block extra_css %}
<style>
    .area-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: #f9f9f9;
    }
    .area-map {
        width: 100%;
        height: 300px;
        border: 1px solid #ccc;
        background: #f0f0f0;
        position: relative;
        cursor: crosshair;
    }
    .area-point {
        position: absolute;
        width: 8px;
        height: 8px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
        transform: translate(-50%, -50%);
    }
    .area-polygon {
        position: absolute;
        border: 2px solid #007bff;
        background: rgba(0, 123, 255, 0.1);
        pointer-events: none;
    }
    .btn-group {
        margin-bottom: 10px;
    }
    .area-stats {
        background: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <h2>ğŸï¸ Ã‡alÄ±ÅŸma AlanlarÄ±</h2>
            
            <!-- Alan Listesi -->
            <div id="area-list">
                <div class="area-card" data-area-id="alan1">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>ğŸŒ± DoÄŸu BahÃ§e</h5>
                            <p class="text-muted">30m x 20m alan (600 mÂ²)</p>
                            <div class="area-stats">
                                <small>
                                    <strong>Son BiÃ§im:</strong> 25 Haziran 2025<br>
                                    <strong>Toplam BiÃ§im:</strong> 12 kez<br>
                                    <strong>Tahmini SÃ¼re:</strong> 45 dakika
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4 text-right">
                            <div class="btn-group-vertical">
                                <button class="btn btn-success btn-sm" onclick="startMowing('alan1')">
                                    âœ‚ï¸ BiÃ§
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="editArea('alan1')">
                                    âœï¸ DÃ¼zenle
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="showArea('alan1')">
                                    ğŸ‘ï¸ GÃ¶ster
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteArea('alan1')">
                                    ğŸ—‘ï¸ Sil
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="area-card" data-area-id="alan2">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>ğŸ BatÄ± Meyve BahÃ§esi</h5>
                            <p class="text-muted">25m x 15m alan (375 mÂ²)</p>
                            <div class="area-stats">
                                <small>
                                    <strong>Son BiÃ§im:</strong> 23 Haziran 2025<br>
                                    <strong>Toplam BiÃ§im:</strong> 8 kez<br>
                                    <strong>Tahmini SÃ¼re:</strong> 30 dakika
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4 text-right">
                            <div class="btn-group-vertical">
                                <button class="btn btn-success btn-sm" onclick="startMowing('alan2')">
                                    âœ‚ï¸ BiÃ§
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="editArea('alan2')">
                                    âœï¸ DÃ¼zenle
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="showArea('alan2')">
                                    ğŸ‘ï¸ GÃ¶ster
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteArea('alan2')">
                                    ğŸ—‘ï¸ Sil
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Yeni Alan Ekleme -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5>â• Yeni Alan Ekle</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary" onclick="startAreaCreation()">
                        ğŸ—ºï¸ Harita Ãœzerinde Ã‡iz
                    </button>
                    <button class="btn btn-secondary ml-2" onclick="importFromGPS()">
                        ğŸ“ GPS KoordinatlarÄ±ndan Ä°Ã§e Aktar
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Harita/Planlama Paneli -->
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ—ºï¸ Alan HaritasÄ±</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" onclick="setMapMode('view')">
                            ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼le
                        </button>
                        <button class="btn btn-outline-primary" onclick="setMapMode('edit')">
                            âœï¸ DÃ¼zenle
                        </button>
                        <button class="btn btn-outline-primary" onclick="setMapMode('create')">
                            â• OluÅŸtur
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="area-map" id="area-map">
                        <!-- Dinamik olarak oluÅŸturulacak alan gÃ¶sterimi -->
                        <div class="area-polygon" style="left: 20px; top: 20px; width: 120px; height: 80px;" title="DoÄŸu BahÃ§e"></div>
                        <div class="area-polygon" style="left: 160px; top: 120px; width: 100px; height: 60px;" title="BatÄ± Meyve BahÃ§esi"></div>
                        
                        <!-- Robot pozisyonu -->
                        <div class="area-point" style="left: 50%; top: 50%; background: #dc3545;" title="Robot Pozisyonu"></div>
                        
                        <!-- Åarj istasyonu -->
                        <div class="area-point" style="left: 10%; top: 10%; background: #28a745;" title="Åarj Ä°stasyonu"></div>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>AÃ§Ä±klama:</strong><br>
                            ğŸŸ¦ Mavi: TanÄ±mlÄ± alanlar<br>
                            ğŸ”´ KÄ±rmÄ±zÄ±: Robot pozisyonu<br>
                            ğŸŸ¢ YeÅŸil: Åarj istasyonu<br>
                            Haritaya tÄ±klayarak yeni alan oluÅŸturabilirsiniz.
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Alan Ä°statistikleri -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5>ğŸ“Š Alan Ä°statistikleri</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">2</h4>
                            <small>TanÄ±mlÄ± Alan</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">975 mÂ²</h4>
                            <small>Toplam Alan</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-info">75 dk</h4>
                            <small>Toplam SÃ¼re</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning">20</h4>
                            <small>Toplam BiÃ§im</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alan DÃ¼zenleme Modal -->
<div class="modal fade" id="editAreaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">âœï¸ Alan DÃ¼zenle</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editAreaForm">
                    <div class="form-group">
                        <label>Alan AdÄ±:</label>
                        <input type="text" class="form-control" id="areaName" placeholder="Ã–rn: DoÄŸu BahÃ§e">
                    </div>
                    
                    <div class="form-group">
                        <label>BiÃ§me AyarlarÄ±:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="small">BiÃ§me YÃ¼ksekliÄŸi:</label>
                                <select class="form-control" id="cuttingHeight">
                                    <option value="1">Seviye 1 (En DÃ¼ÅŸÃ¼k)</option>
                                    <option value="2">Seviye 2</option>
                                    <option value="3" selected>Seviye 3 (Orta)</option>
                                    <option value="4">Seviye 4</option>
                                    <option value="5">Seviye 5 (En YÃ¼ksek)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="small">HÄ±z:</label>
                                <select class="form-control" id="mowingSpeed">
                                    <option value="0.2">YavaÅŸ (0.2 m/s)</option>
                                    <option value="0.4" selected>Normal (0.4 m/s)</option>
                                    <option value="0.6">HÄ±zlÄ± (0.6 m/s)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>BiÃ§me DÃ¼zeni:</label>
                        <select class="form-control" id="mowingPattern">
                            <option value="boustrophedon" selected>BiÃ§erdÃ¶ver (Paralel)</option>
                            <option value="spiral">Spiral</option>
                            <option value="random">Rastgele</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Koordinatlar:</label>
                        <textarea class="form-control" id="areaCoordinates" rows="4" 
                                  placeholder="(0,0), (30,0), (30,20), (0,20)"></textarea>
                        <small class="text-muted">Her satÄ±ra bir koordinat Ã§ifti (x,y) yazÄ±n</small>
                    </div>
                    
                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="enableSchedule">
                            <label class="custom-control-label" for="enableSchedule">
                                Otomatik Zamanlama
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group" id="scheduleOptions" style="display: none;">
                        <label>Zamanlama:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-control" id="scheduleFrequency">
                                    <option value="daily">GÃ¼nlÃ¼k</option>
                                    <option value="weekly" selected>HaftalÄ±k</option>
                                    <option value="monthly">AylÄ±k</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <input type="time" class="form-control" id="scheduleTime" value="09:00">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    âŒ Ä°ptal
                </button>
                <button type="button" class="btn btn-primary" onclick="saveArea()">
                    âœ… Kaydet
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentMapMode = 'view';
let selectedArea = null;
let newAreaPoints = [];

// Harita modu deÄŸiÅŸtirme
function setMapMode(mode) {
    currentMapMode = mode;
    $('.btn-group .btn').removeClass('active');
    $(`button[onclick="setMapMode('${mode}')"]`).addClass('active');
    
    const map = document.getElementById('area-map');
    
    switch(mode) {
        case 'view':
            map.style.cursor = 'default';
            break;
        case 'edit':
            map.style.cursor = 'grab';
            break;
        case 'create':
            map.style.cursor = 'crosshair';
            newAreaPoints = [];
            break;
    }
}

// Alan biÃ§me baÅŸlatma
function startMowing(areaId) {
    if (confirm(`${areaId} alanÄ±nda biÃ§me iÅŸlemini baÅŸlatmak istiyor musunuz?`)) {
        showNotification('ğŸš€ BiÃ§me iÅŸlemi baÅŸlatÄ±ldÄ±!', 'success');
        
        // WebSocket ile robot komutunu gÃ¶nder
        if (socket) {
            socket.emit('start_mowing', {
                area_id: areaId,
                cutting_height: 3,
                speed: 0.4
            });
        }
    }
}

// Alan dÃ¼zenleme
function editArea(areaId) {
    selectedArea = areaId;
    
    // Alan bilgilerini yÃ¼kle (gerÃ§ek uygulamada API'den gelir)
    const areaData = {
        'alan1': {
            name: 'DoÄŸu BahÃ§e',
            cutting_height: 3,
            speed: 0.4,
            pattern: 'boustrophedon',
            coordinates: '(0,0), (30,0), (30,20), (0,20)'
        },
        'alan2': {
            name: 'BatÄ± Meyve BahÃ§esi',
            cutting_height: 2,
            speed: 0.3,
            pattern: 'spiral',
            coordinates: '(5,5), (30,5), (30,20), (5,20)'
        }
    };
    
    const data = areaData[areaId];
    if (data) {
        $('#areaName').val(data.name);
        $('#cuttingHeight').val(data.cutting_height);
        $('#mowingSpeed').val(data.speed);
        $('#mowingPattern').val(data.pattern);
        $('#areaCoordinates').val(data.coordinates);
        
        $('#editAreaModal').modal('show');
    }
}

// Alan gÃ¶sterme/gizleme
function showArea(areaId) {
    const areaCard = $(`.area-card[data-area-id="${areaId}"]`);
    areaCard.toggleClass('border-primary');
    
    // Haritada vurgula
    // Implementation burada olabilir
}

// Alan silme
function deleteArea(areaId) {
    if (confirm('Bu alanÄ± silmek istediÄŸinizden emin misiniz?')) {
        $(`.area-card[data-area-id="${areaId}"]`).fadeOut(() => {
            $(this).remove();
        });
        showNotification('ğŸ—‘ï¸ Alan silindi', 'warning');
    }
}

// Alan kaydetme
function saveArea() {
    const areaData = {
        name: $('#areaName').val(),
        cutting_height: parseInt($('#cuttingHeight').val()),
        speed: parseFloat($('#mowingSpeed').val()),
        pattern: $('#mowingPattern').val(),
        coordinates: $('#areaCoordinates').val(),
        schedule_enabled: $('#enableSchedule').is(':checked'),
        schedule_frequency: $('#scheduleFrequency').val(),
        schedule_time: $('#scheduleTime').val()
    };
    
    // API'ye gÃ¶nder
    if (socket) {
        socket.emit('save_area', {
            area_id: selectedArea,
            data: areaData
        });
    }
    
    $('#editAreaModal').modal('hide');
    showNotification('âœ… Alan ayarlarÄ± kaydedildi', 'success');
}

// Yeni alan oluÅŸturma baÅŸlatma
function startAreaCreation() {
    setMapMode('create');
    showNotification('ğŸ—ºï¸ Harita Ã¼zerinde alan sÄ±nÄ±rlarÄ±nÄ± Ã§izin', 'info');
}

// GPS iÃ§e aktarma
function importFromGPS() {
    // GPS koordinat iÃ§e aktarma modalÄ±
    alert('GPS koordinat iÃ§e aktarma Ã¶zelliÄŸi yakÄ±nda eklenecek!');
}

// Zamanlama seÃ§eneklerini gÃ¶ster/gizle
$('#enableSchedule').change(function() {
    if ($(this).is(':checked')) {
        $('#scheduleOptions').slideDown();
    } else {
        $('#scheduleOptions').slideUp();
    }
});

// Harita tÄ±klama olaylarÄ±
$('#area-map').click(function(e) {
    if (currentMapMode === 'create') {
        const rect = this.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Koordinat sistemi dÃ¶nÃ¼ÅŸÃ¼mÃ¼ (pixel -> metre)
        const realX = (x / rect.width) * 50; // 50m maksimum geniÅŸlik
        const realY = (y / rect.height) * 30; // 30m maksimum yÃ¼kseklik
        
        newAreaPoints.push({x: realX, y: realY, pixelX: x, pixelY: y});
        
        // NoktayÄ± gÃ¶rsel olarak ekle
        const point = $('<div class="area-point"></div>');
        point.css({
            left: x + 'px',
            top: y + 'px',
            background: '#ffc107'
        });
        $(this).append(point);
        
        if (newAreaPoints.length >= 3) {
            // Alan oluÅŸturma tamamlanabilir
            const confirmCreate = confirm(`${newAreaPoints.length} nokta ile alan oluÅŸturulsun mu?`);
            if (confirmCreate) {
                createNewArea();
            }
        }
    }
});

// Yeni alan oluÅŸturma
function createNewArea() {
    const areaName = prompt('Alan adÄ±:', 'Yeni Alan');
    if (areaName) {
        // KoordinatlarÄ± string formatÄ±na Ã§evir
        const coordString = newAreaPoints.map(p => 
            `(${p.realX.toFixed(1)},${p.realY.toFixed(1)})`
        ).join(', ');
        
        // Yeni alan kartÄ±nÄ± ekle
        const newAreaCard = $(`
            <div class="area-card" data-area-id="new-area-${Date.now()}">
                <div class="row">
                    <div class="col-md-8">
                        <h5>ğŸ†• ${areaName}</h5>
                        <p class="text-muted">Yeni tanÄ±mlanmÄ±ÅŸ alan</p>
                        <div class="area-stats">
                            <small>
                                <strong>Koordinatlar:</strong> ${coordString}<br>
                                <strong>Durum:</strong> HenÃ¼z biÃ§ilmedi
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4 text-right">
                        <div class="btn-group-vertical">
                            <button class="btn btn-success btn-sm">âœ‚ï¸ BiÃ§</button>
                            <button class="btn btn-primary btn-sm">âœï¸ DÃ¼zenle</button>
                            <button class="btn btn-warning btn-sm">ğŸ‘ï¸ GÃ¶ster</button>
                            <button class="btn btn-danger btn-sm">ğŸ—‘ï¸ Sil</button>
                        </div>
                    </div>
                </div>
            </div>
        `);
        
        $('#area-list').append(newAreaCard);
        
        // Haritada kalÄ±cÄ± alan olarak gÃ¶ster
        drawAreaOnMap(newAreaPoints);
        
        // Temizle
        newAreaPoints = [];
        $('.area-point[style*="background: rgb(255, 193, 7)"]').remove();
        setMapMode('view');
        
        showNotification('âœ… Yeni alan oluÅŸturuldu!', 'success');
    }
}

// Haritada alan Ã§izme
function drawAreaOnMap(points) {
    if (points.length < 3) return;
    
    // Minimum ve maksimum koordinatlarÄ± bul
    const minX = Math.min(...points.map(p => p.pixelX));
    const minY = Math.min(...points.map(p => p.pixelY));
    const maxX = Math.max(...points.map(p => p.pixelX));
    const maxY = Math.max(...points.map(p => p.pixelY));
    
    const polygon = $('<div class="area-polygon"></div>');
    polygon.css({
        left: minX + 'px',
        top: minY + 'px',
        width: (maxX - minX) + 'px',
        height: (maxY - minY) + 'px',
        border: '2px solid #28a745',
        background: 'rgba(40, 167, 69, 0.1)'
    });
    
    $('#area-map').append(polygon);
}

// Bildirim gÃ¶sterme
function showNotification(message, type = 'info') {
    const alertClass = `alert-${type}`;
    const notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" 
             style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `);
    
    $('body').append(notification);
    
    // 5 saniye sonra otomatik kapat
    setTimeout(() => {
        notification.alert('close');
    }, 5000);
}

// Sayfa yÃ¼klendiÄŸinde
$(document).ready(function() {
    console.log('Alan yÃ¶netimi sayfasÄ± yÃ¼klendi');
});
</script>
{% endblock %}
