{% extends "base.html" %}

{% block title %}Sistem İzleme - OBA Robot{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }

    .metric-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .chart-container {
        height: 300px;
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .log-container {
        height: 400px;
        overflow-y: auto;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }

    .log-entry {
        margin-bottom: 5px;
        padding: 2px 0;
    }

    .log-info {
        color: #007bff;
    }

    .log-warning {
        color: #ffc107;
    }

    .log-error {
        color: #dc3545;
    }

    .log-success {
        color: #28a745;
    }

    .sensor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .sensor-item {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .sensor-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }

    .sensor-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 5px 0;
    }

    .system-health {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .performance-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .network-card {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #333;
    }

    .battery-container {
        position: relative;
        width: 80px;
        height: 40px;
        border: 2px solid #333;
        border-radius: 5px;
        background: #f8f9fa;
        margin: 0 auto;
    }

    .battery-fill {
        height: 100%;
        background: #28a745;
        border-radius: 3px;
        transition: width 0.3s ease, background-color 0.3s ease;
    }

    .battery-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        font-size: 0.8rem;
        color: #333;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Üst Metrikler -->
    <div class="row">
        <div class="col-md-3">
            <div class="metric-card system-health">
                <div class="text-center">
                    <i class="fas fa-heartbeat metric-icon"></i>
                    <div class="metric-value" id="system-health">95%</div>
                    <div class="metric-label">Sistem Sağlığı</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card performance-card">
                <div class="text-center">
                    <i class="fas fa-tachometer-alt metric-icon"></i>
                    <div class="metric-value" id="cpu-usage">12%</div>
                    <div class="metric-label">CPU Kullanımı</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="text-center">
                    <i class="fas fa-memory metric-icon"></i>
                    <div class="metric-value" id="memory-usage">45%</div>
                    <div class="metric-label">RAM Kullanımı</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card network-card">
                <div class="text-center">
                    <i class="fas fa-wifi metric-icon"></i>
                    <div class="metric-value" id="network-status">Güçlü</div>
                    <div class="metric-label">Ağ Durumu</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sol Panel - Sensör Verileri -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-microchip"></i> Sensör Verileri</h5>
                    <div class="form-check form-switch float-end">
                        <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                        <label class="form-check-label text-white" for="auto-refresh">
                            Otomatik Yenile
                        </label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="sensor-grid">
                        <div class="sensor-item">
                            <div class="sensor-icon">
                                <i class="fas fa-thermometer-half text-warning"></i>
                            </div>
                            <div class="sensor-value" id="temperature">--°C</div>
                            <div class="sensor-label">Sıcaklık</div>
                        </div>

                        <div class="sensor-item">
                            <div class="sensor-icon">
                                <i class="fas fa-tint text-info"></i>
                            </div>
                            <div class="sensor-value" id="humidity">--%</div>
                            <div class="sensor-label">Nem</div>
                        </div>

                        <div class="sensor-item">
                            <div class="sensor-icon">
                                <i class="fas fa-eye text-primary"></i>
                            </div>
                            <div class="sensor-value" id="distance">-- cm</div>
                            <div class="sensor-label">Mesafe</div>
                        </div>

                        <div class="sensor-item">
                            <div class="sensor-icon">
                                <i class="fas fa-compass text-success"></i>
                            </div>
                            <div class="sensor-value" id="heading">--°</div>
                            <div class="sensor-label">Yön</div>
                        </div>

                        <div class="sensor-item">
                            <div class="sensor-icon">
                                <i class="fas fa-road text-secondary"></i>
                            </div>
                            <div class="sensor-value" id="inclination">--°</div>
                            <div class="sensor-label">Eğim</div>
                        </div>

                        <div class="sensor-item">
                            <div class="sensor-icon">
                                <i class="fas fa-satellite text-info"></i>
                            </div>
                            <div class="sensor-value" id="gps-satellites">--</div>
                            <div class="sensor-label">GPS Uydu</div>
                        </div>

                        <div class="sensor-item">
                            <div class="sensor-icon">
                                <i class="fas fa-microchip text-warning"></i>
                            </div>
                            <div class="sensor-value">
                                <span id="imu-calibration-status" class="badge bg-success">GOOD</span>
                            </div>
                            <div class="sensor-label">IMU Kalibrasyon</div>
                        </div>

                        <div class="sensor-item">
                            <div class="sensor-icon">
                                <i class="fas fa-thermometer text-danger"></i>
                            </div>
                            <div class="sensor-value" id="imu-temperature">--°C</div>
                            <div class="sensor-label">IMU Sıcaklık</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigasyon Durumu -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-navigation"></i> Navigasyon Sistemi</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-map-marker-alt text-primary"></i> GPS</h6>
                        <p><strong>Konum:</strong> <br>
                            <small id="gps-coordinates">--, --</small>
                        </p>
                        <p><strong>Uydu:</strong> <span id="nav-gps-satellites">--</span></p>
                        <p><strong>Sinyal:</strong>
                            <span id="gps-fix-status" class="badge bg-success">GPS Fix</span>
                        </p>
                        <p><strong>Hız:</strong> <span id="gps-speed">-- m/s</span></p>
                        <p><strong>Yön:</strong> <span id="gps-course">--°</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-compass text-warning"></i> IMU</h6>
                        <p><strong>Açı:</strong> <span id="nav-heading">--°</span></p>
                        <p><strong>Eğim:</strong> <span id="nav-inclination">--°</span></p>
                        <p><strong>Kalibrasyon:</strong>
                            <span id="nav-imu-calibration" class="badge bg-success">GOOD</span>
                        </p>
                        <div class="mt-3">
                            <h6><i class="fas fa-car text-info"></i> Odometry</h6>
                            <p><strong>Pozisyon:</strong> <br>
                                <small>X: <span id="odom-x">--</span> Y: <span id="odom-y">--</span></small>
                            </p>
                            <p><strong>Enkoder:</strong> <br>
                                <small>L: <span id="encoder-left">--</span> R: <span
                                        id="encoder-right">--</span></small>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6><i class="fas fa-layer-group text-success"></i> Sensor Fusion</h6>
                        <div class="progress mb-2">
                            <div id="fusion-confidence" class="progress-bar bg-success" style="width: 0%"></div>
                        </div>
                        <small>Güven: <span id="fusion-confidence-text">0%</span></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performans Grafikleri -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Performans Grafikleri</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Sağ Panel - Sistem Durumu ve Loglar -->
    <div class="col-md-6">
        <!-- Motor Durumları -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Motor Durumları</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Sol Motor</h6>
                        <p><strong>Hız:</strong> <span id="left-motor-speed">-- RPM</span></p>
                        <p><strong>Akım:</strong> <span id="left-motor-current">-- A</span></p>
                        <p><strong>Durum:</strong> <span id="left-motor-state" class="badge bg-secondary">--</span></p>
                        <p><small><strong>Hata:</strong> <span id="left-motor-error"
                                    class="text-success">Normal</span></small></p>
                        <div class="progress mb-2">
                            <div id="left-motor-load" class="progress-bar" style="width: 0%"></div>
                        </div>
                        <small>Yük: <span id="left-motor-load-text">0%</span></small>
                    </div>
                    <div class="col-md-6">
                        <h6>Sağ Motor</h6>
                        <p><strong>Hız:</strong> <span id="right-motor-speed">-- RPM</span></p>
                        <p><strong>Akım:</strong> <span id="right-motor-current">-- A</span></p>
                        <p><strong>Durum:</strong> <span id="right-motor-state" class="badge bg-secondary">--</span></p>
                        <p><small><strong>Hata:</strong> <span id="right-motor-error"
                                    class="text-success">Normal</span></small></p>
                        <div class="progress mb-2">
                            <div id="right-motor-load" class="progress-bar" style="width: 0%"></div>
                        </div>
                        <small>Yük: <span id="right-motor-load-text">0%</span></small>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-md-12">
                        <h6>Biçme Motoru</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <p><strong>Hız:</strong> <span id="blade-motor-speed">-- RPM</span></p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Akım:</strong> <span id="blade-motor-current">-- A</span></p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Durum:</strong> <span id="blade-motor-status"
                                        class="badge bg-secondary">Kapalı</span></p>
                            </div>
                            <div class="col-md-4">
                                <p><small><strong>Hata:</strong> <span id="blade-motor-error"
                                            class="text-success">Normal</span></small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sistem Logları -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-file-alt"></i> Sistem Logları</h5>
                <div class="btn-group float-end" role="group">
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="clearLogs()">
                        <i class="fas fa-trash"></i> Temizle
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="downloadLogs()">
                        <i class="fas fa-download"></i> İndir
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="log-container" id="log-container">
                    <div class="log-entry log-info">[2025-06-28 10:30:15] INFO: Robot başlatıldı</div>
                    <div class="log-entry log-success">[2025-06-28 10:30:16] SUCCESS: Tüm sensörler bağlandı</div>
                    <div class="log-entry log-info">[2025-06-28 10:30:17] INFO: Web server başlatıldı</div>
                    <div class="log-entry log-warning">[2025-06-28 10:30:18] WARNING: GPS sinyali zayıf</div>
                    <div class="log-entry log-info">[2025-06-28 10:30:19] INFO: Manuel kontrol modu aktif</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alt Panel - Batarya ve Güç Yönetimi -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-battery-half"></i> Batarya ve Güç Yönetimi</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="battery-container mb-2">
                                <div class="battery-fill" id="main-battery-fill" style="width: 85%"></div>
                                <div class="battery-text" id="main-battery-text">85%</div>
                            </div>
                            <h6>Ana Batarya</h6>
                            <p><small>Voltaj: <span id="main-battery-voltage">12.6V</span></small></p>
                            <p><small>Akım: <span id="main-battery-current">2.3A</span></small></p>
                            <p><small>Sıcaklık: <span id="main-battery-temp">25°C</span></small></p>
                            <p><small>Sağlık: <span id="main-battery-health" class="badge bg-success">İyi</span></small>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-plug fa-3x text-primary mb-2"></i>
                            <h6>Şarj Durumu</h6>
                            <p><span id="charging-status" class="badge bg-warning">Şarj Olmuyor</span></p>
                            <p><small>Güç: <span id="charging-power">0W</span></small></p>
                            <p><small>Şarj Cihazı: <span id="charger-connected" class="badge bg-secondary">Bağlı
                                        Değil</span></small></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-bolt fa-3x text-warning mb-2"></i>
                            <h6>Toplam Güç</h6>
                            <p><strong><span id="total-power">28.4W</span></strong></p>
                            <p><small>Verimlilik: <span id="power-efficiency">87%</span></small></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Performans grafiği
    const ctx = document.getElementById('performance-chart').getContext('2d');
    const performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU Kullanımı (%)',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1
            }, {
                label: 'RAM Kullanımı (%)',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });

    // Monitoring data update
    function updateMonitoringData() {
        if (!window.obaInterface || !window.obaInterface.connected) return;

        // API'den monitoring data al
        fetch('/api/monitoring')
            .then(response => response.json())
            .then(data => {
                updateSystemMetrics(data.system || {});
                updateSensorData(data.sensors || {});
                updateMotorStatus(data.motors || {});
                updatePowerStatus(data.power || {});
                updatePerformanceChart(data.performance || {});
            })
            .catch(error => {
                console.error('Monitoring data hatası:', error);
            });

        // Navigation data'yı ayrı olarak al
        fetch('/api/navigation')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.navigation) {
                    updateNavigationData(data.navigation);
                }
            })
            .catch(error => {
                console.error('Navigation data hatası:', error);
            });
    }

    function updateSystemMetrics(system) {
        const elements = {
            'system-health': system.health || '95',
            'cpu-usage': system.cpu_usage || '12',
            'memory-usage': system.memory_usage || '45',
            'network-status': system.network_status || 'Güçlü'
        };

        Object.keys(elements).forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                if (id === 'network-status') {
                    // WiFi durumu ve sinyal gücünü göster
                    const signalDbm = system.wifi_signal_dbm || -45;
                    element.textContent = `${elements[id]} (${signalDbm} dBm)`;
                } else {
                    element.textContent = elements[id] + '%';
                }
            }
        });
    }

    function updateSensorData(sensors) {
        const sensorElements = {
            'temperature': (sensors.temperature || 25) + '°C',
            'humidity': (sensors.humidity || 60) + '%',
            'distance': (sensors.distance || 50) + ' cm',
            'heading': (sensors.heading || 180) + '°',
            'inclination': (sensors.inclination || 0) + '°',
            'gps-satellites': sensors.gps_satellites || '8'
        };

        Object.keys(sensorElements).forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = sensorElements[id];

                // Sensör kalitesine göre renk ayarla
                if (id === 'gps-satellites') {
                    const satCount = parseInt(sensors.gps_satellites || 8);
                    if (satCount >= 8) {
                        element.style.color = '#28a745'; // Yeşil
                    } else if (satCount >= 4) {
                        element.style.color = '#ffc107'; // Sarı
                    } else {
                        element.style.color = '#dc3545'; // Kırmızı
                    }
                }
            }
        });

        // IMU ek bilgileri güncelle
        if (sensors.imu_calibration) {
            const imuStatus = document.getElementById('imu-calibration-status');
            if (imuStatus) {
                imuStatus.textContent = sensors.imu_calibration;
                imuStatus.className = sensors.imu_calibration === 'GOOD' ?
                    'badge bg-success' :
                    sensors.imu_calibration === 'FAIR' ?
                        'badge bg-warning' : 'badge bg-danger';
            }
        }

        if (sensors.imu_temperature) {
            const imuTemp = document.getElementById('imu-temperature');
            if (imuTemp) {
                imuTemp.textContent = sensors.imu_temperature + '°C';
            }
        }
    }

    function updateMotorStatus(motors) {
        // Sol motor
        if (motors.left) {
            updateMotorElements('left', motors.left);
        }

        // Sağ motor
        if (motors.right) {
            updateMotorElements('right', motors.right);
        }

        // Biçme motoru
        if (motors.blade) {
            const elements = {
                'blade-motor-speed': (motors.blade.speed || 0) + ' RPM',
                'blade-motor-current': (motors.blade.current || 0) + ' A',
                'blade-motor-status': motors.blade.enabled ? 'Çalışıyor' : 'Kapalı'
            };

            Object.keys(elements).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (id === 'blade-motor-status') {
                        element.textContent = elements[id];
                        element.className = motors.blade.enabled ? 'badge bg-success' : 'badge bg-secondary';
                    } else {
                        element.textContent = elements[id];
                    }
                }
            });

            // Biçme motoru hata durumu
            const bladeError = document.getElementById('blade-motor-error');
            if (bladeError && motors.blade.error_code !== undefined) {
                if (motors.blade.error_code === 0) {
                    bladeError.textContent = 'Normal';
                    bladeError.className = 'text-success';
                } else {
                    bladeError.textContent = `Hata: ${motors.blade.error_code}`;
                    bladeError.className = 'text-danger';
                }
            }
        }
    }

    function updateMotorElements(side, motorData) {
        const elements = {
            [`${side}-motor-speed`]: (motorData.speed || 0) + ' RPM',
            [`${side}-motor-current`]: (motorData.current || 0) + ' A',
            [`${side}-motor-load-text`]: (motorData.load || 0) + '%'
        };

        Object.keys(elements).forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = elements[id];
            }
        });

        // Motor durumu göster
        const stateElement = document.getElementById(`${side}-motor-state`);
        if (stateElement && motorData.state) {
            let stateText = '';
            let stateClass = '';

            switch (motorData.state) {
                case 'running':
                    stateText = 'Çalışıyor';
                    stateClass = 'badge bg-success';
                    break;
                case 'stopped':
                    stateText = 'Durduruldu';
                    stateClass = 'badge bg-secondary';
                    break;
                case 'error':
                    stateText = 'Hata';
                    stateClass = 'badge bg-danger';
                    break;
                default:
                    stateText = 'Bilinmiyor';
                    stateClass = 'badge bg-warning';
            }

            stateElement.textContent = stateText;
            stateElement.className = stateClass;
        }

        // Hata kodu göster
        const errorElement = document.getElementById(`${side}-motor-error`);
        if (errorElement && motorData.error_code !== undefined) {
            if (motorData.error_code === 0) {
                errorElement.textContent = 'Normal';
                errorElement.className = 'text-success';
            } else {
                errorElement.textContent = `Hata: ${motorData.error_code}`;
                errorElement.className = 'text-danger';
            }
        }

        // Load bar
        const loadBar = document.getElementById(`${side}-motor-load`);
        if (loadBar && motorData.load !== undefined) {
            loadBar.style.width = motorData.load + '%';

            if (motorData.load > 80) {
                loadBar.className = 'progress-bar bg-danger';
            } else if (motorData.load > 60) {
                loadBar.className = 'progress-bar bg-warning';
            } else {
                loadBar.className = 'progress-bar bg-success';
            }
        }
    }

    function updatePowerStatus(power) {
        // Ana batarya
        if (power.main_battery) {
            updateBatteryDisplay('main-battery', power.main_battery);
        }

        // Şarj durumu
        const chargingStatus = document.getElementById('charging-status');
        const chargingPower = document.getElementById('charging-power');
        const chargerConnected = document.getElementById('charger-connected');

        if (chargingStatus && power.charging !== undefined) {
            chargingStatus.textContent = power.charging ? 'Şarj Oluyor' : 'Şarj Olmuyor';
            chargingStatus.className = power.charging ? 'badge bg-success' : 'badge bg-warning';
        }

        if (chargingPower && power.charging_power !== undefined) {
            chargingPower.textContent = power.charging_power + 'W';
        }

        if (chargerConnected && power.charger_connected !== undefined) {
            chargerConnected.textContent = power.charger_connected ? 'Bağlı' : 'Bağlı Değil';
            chargerConnected.className = power.charger_connected ? 'badge bg-success' : 'badge bg-secondary';
        }

        // Toplam güç
        const totalPower = document.getElementById('total-power');
        const powerEfficiency = document.getElementById('power-efficiency');

        if (totalPower && power.total_power !== undefined) {
            totalPower.textContent = power.total_power + 'W';
        }

        if (powerEfficiency && power.efficiency !== undefined) {
            powerEfficiency.textContent = power.efficiency + '%';
        }
    }

    function updateBatteryDisplay(prefix, batteryData) {
        const fill = document.getElementById(`${prefix}-fill`);
        const text = document.getElementById(`${prefix}-text`);
        const voltage = document.getElementById(`${prefix}-voltage`);
        const current = document.getElementById(`${prefix}-current`);
        const temp = document.getElementById(`${prefix}-temp`);
        const health = document.getElementById(`${prefix}-health`);

        if (fill && batteryData.level !== undefined) {
            fill.style.width = batteryData.level + '%';

            // Batarya seviyesine göre renk
            if (batteryData.level >= 60) {
                fill.style.backgroundColor = '#28a745'; // Yeşil
            } else if (batteryData.level >= 30) {
                fill.style.backgroundColor = '#ffc107'; // Sarı
            } else {
                fill.style.backgroundColor = '#dc3545'; // Kırmızı
            }
        }

        if (text && batteryData.level !== undefined) {
            text.textContent = batteryData.level + '%';
        }

        if (voltage && batteryData.voltage !== undefined) {
            voltage.textContent = batteryData.voltage + 'V';
        }

        if (current && batteryData.current !== undefined) {
            current.textContent = batteryData.current + 'A';
        }

        if (temp && batteryData.temperature !== undefined) {
            temp.textContent = batteryData.temperature + '°C';
        }

        if (health && batteryData.health !== undefined) {
            health.textContent = batteryData.health === 'GOOD' ? 'İyi' :
                batteryData.health === 'FAIR' ? 'Orta' : 'Kötü';
            health.className = batteryData.health === 'GOOD' ? 'badge bg-success' :
                batteryData.health === 'FAIR' ? 'badge bg-warning' : 'badge bg-danger';
        }
    }

    function updatePerformanceChart(performance) {
        if (!performance.timestamps || !performance.cpu || !performance.memory) return;

        const chart = performanceChart;
        const maxPoints = 20;

        // Timestamps
        if (performance.timestamps.length > maxPoints) {
            performance.timestamps = performance.timestamps.slice(-maxPoints);
            performance.cpu = performance.cpu.slice(-maxPoints);
            performance.memory = performance.memory.slice(-maxPoints);
        }

        chart.data.labels = performance.timestamps;
        chart.data.datasets[0].data = performance.cpu;
        chart.data.datasets[1].data = performance.memory;

        chart.update('none'); // Animasyon olmadan güncelle
    }

    function updateNavigationData(navigation) {
        try {
            // GPS verileri
            if (navigation.gps) {
                const gps = navigation.gps;

                // GPS koordinatları
                const coords = document.getElementById('gps-coordinates');
                if (coords && gps.latitude && gps.longitude) {
                    coords.textContent = `${gps.latitude.toFixed(6)}, ${gps.longitude.toFixed(6)}`;
                }

                // GPS uydu sayısı
                const navSats = document.getElementById('nav-gps-satellites');
                if (navSats) {
                    navSats.textContent = gps.satellites || 0;
                }

                // GPS fix durumu
                const fixStatus = document.getElementById('gps-fix-status');
                if (fixStatus) {
                    fixStatus.textContent = gps.fix ? 'GPS Fix' : 'No Fix';
                    fixStatus.className = gps.fix ? 'badge bg-success' : 'badge bg-danger';
                }

                // GPS hız ve yön
                const speed = document.getElementById('gps-speed');
                if (speed) {
                    speed.textContent = (gps.speed || 0).toFixed(2) + ' m/s';
                }

                const course = document.getElementById('gps-course');
                if (course) {
                    course.textContent = (gps.course || 0).toFixed(1) + '°';
                }
            }

            // IMU verileri
            if (navigation.imu) {
                const imu = navigation.imu;

                const navHeading = document.getElementById('nav-heading');
                if (navHeading) {
                    navHeading.textContent = (imu.heading || 0).toFixed(1) + '°';
                }

                const navInclination = document.getElementById('nav-inclination');
                if (navInclination) {
                    navInclination.textContent = (imu.inclination || 0).toFixed(1) + '°';
                }

                const navCalibration = document.getElementById('nav-imu-calibration');
                if (navCalibration) {
                    navCalibration.textContent = imu.calibration || 'UNKNOWN';
                    navCalibration.className = imu.calibration === 'GOOD' ? 'badge bg-success' :
                        imu.calibration === 'FAIR' ? 'badge bg-warning' : 'badge bg-danger';
                }
            }

            // Odometry verileri
            if (navigation.odometry) {
                const odom = navigation.odometry;

                const odomX = document.getElementById('odom-x');
                if (odomX && odom.position) {
                    odomX.textContent = (odom.position.x || 0).toFixed(3) + 'm';
                }

                const odomY = document.getElementById('odom-y');
                if (odomY && odom.position) {
                    odomY.textContent = (odom.position.y || 0).toFixed(3) + 'm';
                }

                const encoderLeft = document.getElementById('encoder-left');
                if (encoderLeft && odom.encoder_counts) {
                    encoderLeft.textContent = odom.encoder_counts.left || 0;
                }

                const encoderRight = document.getElementById('encoder-right');
                if (encoderRight && odom.encoder_counts) {
                    encoderRight.textContent = odom.encoder_counts.right || 0;
                }
            }

            // Sensor fusion confidence
            if (navigation.fusion) {
                const fusion = navigation.fusion;

                const confidenceBar = document.getElementById('fusion-confidence');
                const confidenceText = document.getElementById('fusion-confidence-text');

                if (confidenceBar && fusion.confidence !== undefined) {
                    const confidence = Math.round(fusion.confidence * 100);
                    confidenceBar.style.width = confidence + '%';

                    if (confidenceText) {
                        confidenceText.textContent = confidence + '%';
                    }

                    // Confidence seviyesine göre renk
                    if (confidence >= 80) {
                        confidenceBar.className = 'progress-bar bg-success';
                    } else if (confidence >= 60) {
                        confidenceBar.className = 'progress-bar bg-warning';
                    } else {
                        confidenceBar.className = 'progress-bar bg-danger';
                    }
                }
            }

        } catch (error) {
            console.error('Navigation data güncelleme hatası:', error);
        }
    }

    function addLogEntry(message, type = 'info') {
        const logContainer = document.getElementById('log-container');
        if (!logContainer) return;

        const timestamp = new Date().toLocaleString('tr-TR');
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry log-${type}`;
        logEntry.textContent = `[${timestamp}] ${type.toUpperCase()}: ${message}`;

        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;

        // Maksimum 100 log entry tut
        const entries = logContainer.children;
        if (entries.length > 100) {
            logContainer.removeChild(entries[0]);
        }
    }

    function clearLogs() {
        const logContainer = document.getElementById('log-container');
        if (logContainer) {
            logContainer.innerHTML = '';
            addLogEntry('Log temizlendi', 'info');
        }
    }

    function downloadLogs() {
        const logContainer = document.getElementById('log-container');
        if (!logContainer) return;

        const logs = Array.from(logContainer.children).map(entry => entry.textContent).join('\n');
        const blob = new Blob([logs], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `oba_robot_logs_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Auto refresh toggle
    let autoRefreshInterval;

    document.getElementById('auto-refresh').addEventListener('change', function (e) {
        if (e.target.checked) {
            autoRefreshInterval = setInterval(updateMonitoringData, 2000);
            addLogEntry('Otomatik yenileme aktif', 'info');
        } else {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            addLogEntry('Otomatik yenileme deaktif', 'warning');
        }
    });

    // Log fonksiyonları
    function clearLogs() {
        const logContainer = document.getElementById('log-container');
        logContainer.innerHTML = '<div class="log-entry log-info">[' + new Date().toLocaleString() + '] INFO: Loglar temizlendi</div>';
    }

    function downloadLogs() {
        fetch('/api/logs')
            .then(response => response.json())
            .then(data => {
                if (data.logs) {
                    const logText = data.logs.join('\n');
                    const blob = new Blob([logText], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `oba_robot_logs_${new Date().toISOString().split('T')[0]}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    addLogEntry('Loglar indirildi', 'success');
                } else {
                    addLogEntry('Log indirme hatası', 'error');
                }
            })
            .catch(error => {
                console.error('Log download error:', error);
                addLogEntry('Log indirme hatası: ' + error.message, 'error');
            });
    }

    function loadSystemLogs() {
        fetch('/api/logs')
            .then(response => response.json())
            .then(data => {
                const logContainer = document.getElementById('log-container');
                if (data.logs && data.logs.length > 0) {
                    // Son 50 log girişini göster
                    const recentLogs = data.logs.slice(-50);
                    logContainer.innerHTML = '';

                    recentLogs.forEach(logLine => {
                        const entry = document.createElement('div');
                        entry.className = 'log-entry';

                        // Log seviyesini belirle
                        if (logLine.includes('ERROR')) {
                            entry.classList.add('log-error');
                        } else if (logLine.includes('WARNING')) {
                            entry.classList.add('log-warning');
                        } else if (logLine.includes('SUCCESS')) {
                            entry.classList.add('log-success');
                        } else {
                            entry.classList.add('log-info');
                        }

                        entry.textContent = logLine;
                        logContainer.appendChild(entry);
                    });

                    // En son log'a scroll
                    logContainer.scrollTop = logContainer.scrollHeight;
                } else {
                    logContainer.innerHTML = '<div class="log-entry log-info">[' + new Date().toLocaleString() + '] INFO: Henüz log girişi yok</div>';
                }
            })
            .catch(error => {
                console.error('Log loading error:', error);
                const logContainer = document.getElementById('log-container');
                logContainer.innerHTML = '<div class="log-entry log-error">[' + new Date().toLocaleString() + '] ERROR: Log yükleme hatası: ' + error.message + '</div>';
            });
    }

    function addLogEntry(message, level = 'info') {
        const logContainer = document.getElementById('log-container');
        const entry = document.createElement('div');
        entry.className = `log-entry log-${level}`;
        entry.textContent = `[${new Date().toLocaleString()}] ${level.toUpperCase()}: ${message}`;

        logContainer.appendChild(entry);

        // Scroll to bottom
        logContainer.scrollTop = logContainer.scrollHeight;

        // Max 100 log girişi tut
        while (logContainer.children.length > 100) {
            logContainer.removeChild(logContainer.firstChild);
        }
    }

    // İlk yükleme
    document.addEventListener('DOMContentLoaded', function () {
        // İlk veri yüklemesi
        setTimeout(updateMonitoringData, 1000);

        // Sistem loglarını yükle
        loadSystemLogs();

        // Otomatik yenileme başlat
        autoRefreshInterval = setInterval(updateMonitoringData, 2000);

        // Log yenileme için interval
        setInterval(loadSystemLogs, 10000); // 10 saniyede bir log yenile

        addLogEntry('İzleme paneli başlatıldı', 'success');
    });
</script>
{% endblock %}
